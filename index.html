<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–£–º–Ω—ã–π —Ç—Ä–µ–π–¥–∏–Ω–≥-–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* –í—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è */
    :root {
      --bg-body: #f7f9fc;
      --bg-card: #eef7ff;
      --text: #333;
      --border: #b3d9ff;
      --header: #2c3e50;
      --btn-primary: #3498db;
      --btn-secondary: #95a5a6;
      --btn-danger: #e74c3c;
      --btn-success: #27ae60;
    }

    body.dark-mode {
      --bg-body: #121212;
      --bg-card: #1e1e1e;
      --text: #e0e0e0;
      --border: #444;
      --header: #bbdefb;
      --btn-primary: #1976d2;
      --btn-secondary: #666;
      --btn-danger: #d32f2f;
      --btn-success: #2ecc71;
    }

    /* –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ */
    .login-section {
      text-align: center;
      padding: 20px;
      background: var(--bg-card);
      border-radius: 10px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }

    .user-info {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }

    .user-name {
      font-weight: bold;
      font-size: 16px;
    }

    .telegram-login-button {
      background: #0088cc;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin: 0 auto;
    }

    .telegram-login-button:hover {
      background: #0077b3;
    }

    .loading {
      opacity: 0.7;
      pointer-events: none;
    }

    .sync-status {
      font-size: 12px;
      color: #7f8c8d;
      margin-top: 5px;
    }

    .sync-success {
      color: #27ae60;
    }

    .sync-error {
      color: #e74c3c;
    }

    /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 15px;
      background: var(--bg-body);
      color: var(--text);
      line-height: 1.6;
      transition: background-color 0.3s ease;
      min-height: 100vh;
    }

    /* ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ ... */

  </style>
</head>
<body>
  <div class="theme-toggle" id="themeToggle" role="button" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
    <svg id="themeIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M12 3a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0V4a1 1 0 0 1 1-1zm7.07 3.07a1 1 0 0 1 0 1.414l-.707.707a1 1 0 1 1-1.414-1.414l.707-.707a1 1 0 0 1 1.414 0zm-14.14 0a1 1 0 0 1 1.414 0l.707.707A1 1 0 1 1 5.64 5.78l-.707-.707a1 1 0 0 1 0-1.414zM12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8zm-7 4a7 7 0 0 1 14 0 7 7 0 1 1-14 0z" />
    </svg>
  </div>

  <div class="container">
    <!-- –°–µ–∫—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div class="login-section" id="loginSection">
      <h2>üîê –í—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram</h2>
      <div id="userInfo" style="display: none;">
        <div class="user-info">
          <img id="userAvatar" class="user-avatar" src="" alt="–ê–≤–∞—Ç–∞—Ä">
          <div class="user-name" id="userName"></div>
        </div>
        <button class="telegram-login-button" onclick="logout()">
          üö™ –í—ã–π—Ç–∏
        </button>
      </div>
      <div id="loginButton" style="display: none;">
        <button class="telegram-login-button" onclick="loginWithTelegram()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.78 5.42-.9 6.8-.06.67-.36.89-.89.56-2.45-1.83-3.57-2.98-5.78-4.78-.54-.4-.92-.61-.88-1.17.06-.72 1.17-.72 1.61-.5 1.72 1.15 3.08 2.07 4.99 3.22.75.43 1.28.41 1.78-.14.56-.62.78-1.38 1.12-2.18.34-.82.67-1.65 1-2.47.23-.56-.17-.83-.67-.5z"/>
          </svg>
          –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram
        </button>
      </div>
      <div class="sync-status" id="syncStatus"></div>
    </div>

    <h1>üéØ –£–º–Ω—ã–π —Ç—Ä–µ–π–¥–∏–Ω–≥-–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</h1>

    <!-- –û—Å—Ç–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
    <div class="grid">
      <div class="form-group">
        <label for="depositRub">–î–µ–ø–æ–∑–∏—Ç (—Ä—É–±):</label>
        <input type="number" id="depositRub" step="any" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 100000" value="100000"/>
      </div>
      <div class="form-group">
        <label for="depositUsd">–î–µ–ø–æ–∑–∏—Ç (USD):</label>
        <input type="number" id="depositUsd" step="any" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 1100" value="1050"/>
      </div>
    </div>

    <!-- ... –æ—Å—Ç–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å —Ñ–æ—Ä–º—ã ... -->

  </div>

  <input type="file" id="importFile" accept=".csv" style="display: none;">

  <script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞
    const SERVER_URL = 'https://your-app-name.onrender.com/api'; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à URL —Å–µ—Ä–≤–µ—Ä–∞
    const USD_RATE = 95;
    
    let trades = [];
    let profitChart = null;
    let currentCalculation = null;
    let currentUser = null;
    let isOnline = false;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    document.addEventListener('DOMContentLoaded', function() {
      initApp();
    });

    async function initApp() {
      syncDeposits();
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
      const savedUser = localStorage.getItem('telegramUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showUserInfo(currentUser);
        await loadTradesFromServer();
      } else {
        showLoginButton();
      }

      updateHistory();
      updateAnalytics();
      renderChart();

      const isDark = localStorage.getItem('darkMode') === 'true';
      enableDarkMode(isDark);

      document.getElementById('importFile').addEventListener('change', handleImport);
    }

    // –§—É–Ω–∫—Ü–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    function loginWithTelegram() {
      // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Telegram Web App API
      const testUser = {
        id: Math.random().toString(36).substr(2, 9),
        first_name: '–¢–µ—Å—Ç–æ–≤—ã–π –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
        username: 'test_user',
        photo_url: 'https://via.placeholder.com/40'
      };
      
      handleTelegramAuth(testUser);
    }

    function handleTelegramAuth(user) {
      currentUser = user;
      localStorage.setItem('telegramUser', JSON.stringify(user));
      showUserInfo(user);
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
      saveUserToServer(user);
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–¥–µ–ª–∫–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
      loadTradesFromServer();
    }

    function showUserInfo(user) {
      document.getElementById('userInfo').style.display = 'block';
      document.getElementById('loginButton').style.display = 'none';
      document.getElementById('userName').textContent = user.first_name;
      if (user.photo_url) {
        document.getElementById('userAvatar').src = user.photo_url;
      }
    }

    function showLoginButton() {
      document.getElementById('userInfo').style.display = 'none';
      document.getElementById('loginButton').style.display = 'block';
    }

    function logout() {
      currentUser = null;
      localStorage.removeItem('telegramUser');
      trades = [];
      showLoginButton();
      updateHistory();
      updateAnalytics();
      renderChart();
    }

    // API —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–µ—Ä–≤–µ—Ä–æ–º
    async function saveUserToServer(user) {
      try {
        const response = await fetch(`${SERVER_URL}/users`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            telegramId: user.id,
            firstName: user.first_name,
            username: user.username,
            photoUrl: user.photo_url
          })
        });
        
        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ');
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
      }
    }

    async function saveTradesToServer() {
      if (!currentUser) return;
      
      try {
        updateSyncStatus('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...', 'loading');
        
        const response = await fetch(`${SERVER_URL}/trades`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            telegramId: currentUser.id,
            trades: trades
          })
        });
        
        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–¥–µ–ª–æ–∫');
        
        const result = await response.json();
        updateSyncStatus('–î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã', 'success');
        isOnline = true;
        return result;
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–¥–µ–ª–æ–∫:', error);
        updateSyncStatus('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', 'error');
        isOnline = false;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –∫–∞–∫ fallback
        localStorage.setItem('trades_backup', JSON.stringify(trades));
      }
    }

    async function loadTradesFromServer() {
      if (!currentUser) return;
      
      try {
        updateSyncStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...', 'loading');
        
        const response = await fetch(`${SERVER_URL}/trades/${currentUser.id}`);
        
        if (!response.ok) {
          // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ backup
          const backup = localStorage.getItem('trades_backup');
          if (backup) {
            trades = JSON.parse(backup);
            updateSyncStatus('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏', 'warning');
          } else {
            trades = [];
            updateSyncStatus('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ', 'warning');
          }
          return;
        }
        
        const data = await response.json();
        trades = data.trades || [];
        updateSyncStatus('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
        isOnline = true;
        
        updateHistory();
        updateAnalytics();
        renderChart();
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–¥–µ–ª–æ–∫:', error);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ backup
        const backup = localStorage.getItem('trades_backup');
        if (backup) {
          trades = JSON.parse(backup);
          updateSyncStatus('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏', 'warning');
        } else {
          trades = [];
          updateSyncStatus('–û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º', 'error');
        }
        isOnline = false;
        
        updateHistory();
        updateAnalytics();
        renderChart();
      }
    }

    function updateSyncStatus(message, type) {
      const statusElement = document.getElementById('syncStatus');
      statusElement.textContent = message;
      statusElement.className = 'sync-status';
      
      if (type === 'success') statusElement.classList.add('sync-success');
      if (type === 'error') statusElement.classList.add('sync-error');
      if (type === 'loading') statusElement.classList.add('loading');
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å–æ —Å–¥–µ–ª–∫–∞–º–∏
    async function saveTrade() {
      if (!currentUser) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }

      if (!currentCalculation) {
        alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ä–∞—Å—á—ë—Ç.");
        return;
      }

      try {
        const trade = {
          id: generateId(),
          date: new Date().toLocaleString('ru-RU'),
          timestamp: new Date().toISOString(),
          ticker: document.getElementById("resultTicker").textContent,
          entry: parseFloat(document.getElementById("entry").value),
          sl: parseFloat(document.getElementById("sl").value),
          tp1: parseFloat(document.getElementById("tp1_price").value) || 0,
          tp2: parseFloat(document.getElementById("tp2_price").value) || 0,
          tp3: parseFloat(document.getElementById("tp3_price").value) || 0,
          tp1_size: parseFloat(document.getElementById("tp1_size").value) || 0,
          tp2_size: parseFloat(document.getElementById("tp2_size").value) || 0,
          tp3_size: parseFloat(document.getElementById("tp3_size").value) || 0,
          leverage: parseInt(document.getElementById("leverage").value),
          rr: currentCalculation.rr,
          profitMoney: currentCalculation.profitRub.toFixed(2),
          profitUsd: currentCalculation.profitUsd.toFixed(2),
          moneyRiskRub: currentCalculation.moneyRiskRub,
          potentialProfitRub: currentCalculation.profitRub,
          closedBy: 'tp'
        };

        trades.push(trade);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        await saveTradesToServer();
        
        updateHistory();
        updateAnalytics();
        renderChart();
        alert("–°–¥–µ–ª–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!");
      } catch (error) {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–¥–µ–ª–∫–∏: " + error.message);
        console.error(error);
      }
    }

    async function recordStopLoss() {
      if (!currentUser) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        return;
      }

      if (!currentCalculation) {
        alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ä–∞—Å—á—ë—Ç.");
        return;
      }

      try {
        const trade = {
          id: generateId(),
          date: new Date().toLocaleString('ru-RU'),
          timestamp: new Date().toISOString(),
          ticker: document.getElementById("resultTicker").textContent,
          entry: parseFloat(document.getElementById("entry").value),
          sl: parseFloat(document.getElementById("sl").value),
          tp1: parseFloat(document.getElementById("tp1_price").value) || 0,
          tp2: parseFloat(document.getElementById("tp2_price").value) || 0,
          tp3: parseFloat(document.getElementById("tp3_price").value) || 0,
          tp1_size: parseFloat(document.getElementById("tp1_size").value) || 0,
          tp2_size: parseFloat(document.getElementById("tp2_size").value) || 0,
          tp3_size: parseFloat(document.getElementById("tp3_size").value) || 0,
          leverage: parseInt(document.getElementById("leverage").value),
          rr: currentCalculation.rr,
          profitMoney: (-currentCalculation.moneyRiskRub).toFixed(2),
          profitUsd: (-currentCalculation.moneyRiskUsd).toFixed(2),
          moneyRiskRub: currentCalculation.moneyRiskRub,
          potentialProfitRub: currentCalculation.profitRub,
          closedBy: 'sl'
        };

        trades.push(trade);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        await saveTradesToServer();
        
        updateHistory();
        updateAnalytics();
        renderChart();
        alert(`–°–¥–µ–ª–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞ –ø–æ —Å—Ç–æ–ø-–ª–æ—Å—Å—É. –£–±—ã—Ç–æ–∫: ${currentCalculation.moneyRiskRub.toFixed(2)} —Ä—É–±`);
      } catch (error) {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ —Å—Ç–æ–ø-–ª–æ—Å—Å–∞: " + error.message);
        console.error(error);
      }
    }

    async function deleteTrade(index) {
      if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å–¥–µ–ª–∫—É?")) {
        trades.splice(index, 1);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        await saveTradesToServer();
        
        updateHistory();
        updateAnalytics();
        renderChart();
      }
    }

    async function updateTradeCloseType(index, closeType) {
      const trade = trades[index];
      
      trade.closedBy = closeType;
      
      if (closeType === 'tp') {
        trade.profitMoney = trade.potentialProfitRub.toFixed(2);
      } else {
        trade.profitMoney = (-trade.moneyRiskRub).toFixed(2);
      }
      
      trade.profitUsd = (parseFloat(trade.profitMoney) / USD_RATE).toFixed(2);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
      await saveTradesToServer();
      
      updateHistory();
      updateAnalytics();
      renderChart();
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (calculate, updateHistory, updateAnalytics, renderChart –∏ —Ç.–¥.)
    // –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –Ω–æ —Ç–µ–ø–µ—Ä—å –æ–Ω–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Å –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π trades
    function syncDeposits() {
      const depositRub = document.getElementById("depositRub");
      const depositUsd = document.getElementById("depositUsd");
      
      depositRub.addEventListener('input', function() {
        const rub = parseFloat(this.value);
        if (!isNaN(rub)) {
          depositUsd.value = (rub / USD_RATE).toFixed(2);
        }
      });
      
      depositUsd.addEventListener('input', function() {
        const usd = parseFloat(this.value);
        if (!isNaN(usd)) {
          depositRub.value = (usd * USD_RATE).toFixed(2);
        }
      });
    }

    function calculate() {
      try {
        const depositRub = parseFloat(document.getElementById("depositRub").value);
        const riskPercentOnTrade = parseFloat(document.getElementById("riskPercent").value);
        const entry = parseFloat(document.getElementById("entry").value);
        const sl = parseFloat(document.getElementById("sl").value);
        const leverage = parseInt(document.getElementById("leverage").value);
        const ticker = document.getElementById("ticker").value;

        const tp1 = { 
          price: parseFloat(document.getElementById("tp1_price").value) || 0, 
          size: parseFloat(document.getElementById("tp1_size").value) || 0 
        };
        const tp2 = { 
          price: parseFloat(document.getElementById("tp2_price").value) || 0, 
          size: parseFloat(document.getElementById("tp2_size").value) || 0 
        };
        const tp3 = { 
          price: parseFloat(document.getElementById("tp3_price").value) || 0, 
          size: parseFloat(document.getElementById("tp3_size").value) || 0 
        };

        if (!entry || !sl) {
          alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ü–µ–Ω—É –≤—Ö–æ–¥–∞ –∏ —Å—Ç–æ–ø-–ª–æ—Å—Å.");
          return;
        }

        const totalTP = tp1.size + tp2.size + tp3.size;
        if (totalTP !== 100) {
          alert("–°—É–º–º–∞ TP –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 100%!");
          return;
        }

        // ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ calculate –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ...
        const moneyRiskRub = (depositRub * riskPercentOnTrade) / 100;
        const moneyRiskUsd = moneyRiskRub / USD_RATE;

        let priceRiskPercent;
        if (entry > sl) {
          priceRiskPercent = ((entry - sl) / entry) * 100;
        } else {
          priceRiskPercent = ((sl - entry) / entry) * 100;
        }

        let priceProfitPercent = 0;
        if (entry > sl) {
          if (tp1.price > entry) priceProfitPercent += ((tp1.price - entry) / entry) * (tp1.size / 100);
          if (tp2.price > entry) priceProfitPercent += ((tp2.price - entry) / entry) * (tp2.size / 100);
          if (tp3.price > entry) priceProfitPercent += ((tp3.price - entry) / entry) * (tp3.size / 100);
        } else {
          if (tp1.price < entry) priceProfitPercent += ((entry - tp1.price) / entry) * (tp1.size / 100);
          if (tp2.price < entry) priceProfitPercent += ((entry - tp2.price) / entry) * (tp2.size / 100);
          if (tp3.price < entry) priceProfitPercent += ((entry - tp3.price) / entry) * (tp3.size / 100);
        }
        priceProfitPercent *= 100;

        const rr = priceProfitPercent / priceRiskPercent;
        const positionSizeUSDT = moneyRiskUsd / (priceRiskPercent / 100);
        const profitUsd = positionSizeUSDT * (priceProfitPercent / 100) * leverage;
        const profitRub = profitUsd * USD_RATE;
        const profitPercentDeposit = (profitRub / depositRub) * 100;

        currentCalculation = {
          moneyRiskRub,
          moneyRiskUsd,
          priceRiskPercent,
          priceProfitPercent,
          rr: rr.toFixed(2),
          leverage,
          profitRub,
          profitUsd,
          profitPercentDeposit,
          positionSizeUSDT,
          tp1: tp1.price,
          tp2: tp2.price,
          tp3: tp3.price,
          tp1_size: tp1.size,
          tp2_size: tp2.size,
          tp3_size: tp3.size
        };

        document.getElementById("resultTicker").textContent = ticker;
        document.getElementById("moneyRisk").textContent = moneyRiskRub.toFixed(2);
        document.getElementById("moneyRiskUsd").textContent = moneyRiskUsd.toFixed(2);
        document.getElementById("riskPercentVal").textContent = priceRiskPercent.toFixed(2);
        document.getElementById("profitPercentVal").textContent = priceProfitPercent.toFixed(2);
        document.getElementById("rrValue").textContent = rr.toFixed(2);
        document.getElementById("leverageUsed").textContent = leverage;
        document.getElementById("profitMoney").textContent = profitRub.toFixed(2);
        document.getElementById("profitUsd").textContent = profitUsd.toFixed(2);
        document.getElementById("profitPercentDeposit").textContent = profitPercentDeposit.toFixed(2);
        document.getElementById("positionSize").textContent = positionSizeUSDT.toFixed(2);

        const rrEl = document.getElementById("rrValue");
        rrEl.className = rr >= 2 ? "rr-good" : rr >= 1 ? "rr-warn" : "";

        document.getElementById("result").style.display = "block";
      } catch (error) {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ: " + error.message);
        console.error(error);
      }
    }

    // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ...

  </script>
</body>
</html>

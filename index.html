<!DOCTYPE html>
<html lang="ru">
<head>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
<button onclick="closeApp()">–ó–∞–∫—Ä—ã—Ç—å</button>

<script>
  function closeApp() {
    if (window.Telegram && Telegram.WebApp) {
      Telegram.WebApp.close();
    }
  }

  // –ü–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç
  console.log('Telegram WebApp:', Telegram.WebApp);
</script>

  
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–£–º–Ω—ã–π —Ç—Ä–µ–π–¥–∏–Ω–≥-–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
    :root {
      --bg-body: #f7f9fc;
      --bg-card: #eef7ff;
      --text: #333;
      --border: #b3d9ff;
      --header: #2c3e50;
      --btn-primary: #3498db;
      --btn-secondary: #95a5a6;
      --btn-danger: #e74c3c;
      --btn-success: #27ae60;
    }

    body.dark-mode {
      --bg-body: #121212;
      --bg-card: #1e1e1e;
      --text: #e0e0e0;
      --border: #444;
      --header: #bbdefb;
      --btn-primary: #1976d2;
      --btn-secondary: #666;
      --btn-danger: #d32f2f;
      --btn-success: #2ecc71;
    }

    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 15px;
      background: var(--bg-body);
      color: var(--text);
      line-height: 1.6;
      transition: background-color 0.3s ease;
      min-height: 100vh;
    }

    h1, h2, h3 {
      color: var(--header);
      text-align: center;
      margin: 15px 0;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .form-group {
      margin-bottom: 12px;
    }

    label {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
      font-size: 14px;
    }

    input, select, button, textarea {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
      width: 100%;
      box-sizing: border-box;
      transition: border 0.3s, background 0.3s;
    }

    body.dark-mode input, 
    body.dark-mode select {
      background: #2d2d2d !important;
      border-color: #555 !important;
      color: var(--text) !important;
    }

    button {
      background: var(--btn-primary);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      border-radius: 6px;
      margin: 4px 0;
    }

    button:hover {
      opacity: 0.9;
    }

    button.secondary {
      background: var(--btn-secondary);
    }

    button.danger {
      background: var(--btn-danger);
    }

    button.success {
      background: var(--btn-success);
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .divider {
      margin: 15px 0;
      border: 1px solid #ddd;
    }

    .result, .history, .analytics {
      margin-top: 15px;
      padding: 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 14px;
    }

    th, td {
      padding: 6px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      background: var(--btn-primary);
      color: white;
    }

    body.dark-mode th, 
    body.dark-mode td,
    body.dark-mode table {
      border-color: #444;
    }

    .rr-good { color: #27ae60; font-weight: bold; }
    .rr-warn { color: #e67e22; font-weight: bold; }
    .profit-positive { color: #27ae60; }
    .profit-negative { color: #e74c3c; }
    .empty {
      text-align: center;
      color: #7f8c8d;
      font-style: italic;
      padding: 15px;
    }

    .chart-container {
      margin-top: 15px;
      height: 300px;
      background: white;
      padding: 12px;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    body.dark-mode .chart-container {
      background: #1e1e1e;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    .theme-toggle {
      position: fixed;
      top: 15px;
      right: 15px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--btn-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 1000;
      transition: transform 0.2s;
    }

    .theme-toggle:hover {
      transform: scale(1.1);
    }

    .theme-toggle svg {
      width: 18px;
      height: 18px;
      fill: white;
    }

    .delete-trade, .edit-trade {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 18px;
      padding: 5px;
    }

    .delete-trade {
      color: #e74c3c;
    }

    .edit-trade {
      color: #3498db;
    }

    .trade-actions {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .close-type {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 3px;
      background: #3498db;
      color: white;
      margin-left: 5px;
    }

    .close-stopped {
      background: #e74c3c;
    }

    .stop-loss-section {
      margin-top: 12px;
      padding: 12px;
      background: #fdf2f2;
      border: 1px solid #e74c3c;
      border-radius: 6px;
    }

    body.dark-mode .stop-loss-section {
      background: #381a1a;
      border-color: #a0332c;
    }

    .buttons-row {
      display: flex;
      gap: 10px;
      margin: 10px 0;
      flex-wrap: wrap;
    }

    .buttons-row button {
      flex: 1;
      min-width: 120px;
    }

    .editable {
      cursor: pointer;
      border-bottom: 1px dashed #3498db;
    }

    .editable:hover {
      background: rgba(52, 152, 219, 0.1);
    }

    .editable-input {
      width: 100%;
      padding: 2px 4px;
      border: 1px solid #3498db;
      border-radius: 3px;
      background: white;
    }

    body.dark-mode .editable-input {
      background: #2d2d2d;
      color: white;
    }

    .close-type-select {
      padding: 2px 4px;
      border-radius: 3px;
      border: 1px solid #ccc;
      font-size: 12px;
    }

    body.dark-mode .close-type-select {
      background: #2d2d2d;
      color: white;
      border-color: #555;
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      .grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .form-group {
        margin-bottom: 10px;
      }
      
      input, select, button {
        font-size: 16px;
        padding: 12px;
      }
      
      .buttons-row {
        flex-direction: column;
      }
      
      .buttons-row button {
        min-width: auto;
      }
      
      .chart-container {
        height: 250px;
      }
      
      table {
        font-size: 13px;
      }
      
      th, td {
        padding: 4px;
      }
      
      .result, .history, .analytics {
        padding: 10px;
      }
      
      .theme-toggle {
        top: 10px;
        right: 10px;
        width: 36px;
        height: 36px;
      }
      
      .theme-toggle svg {
        width: 16px;
        height: 16px;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      
      h1 {
        font-size: 1.3rem;
      }
      
      .form-group {
        margin-bottom: 8px;
      }
      
      input, select, button {
        font-size: 15px;
        padding: 10px;
      }
      
      .buttons-row {
        gap: 5px;
      }
      
      .chart-container {
        height: 200px;
      }
      
      th, td {
        padding: 3px;
        font-size: 12px;
      }
      
      .close-type {
        font-size: 10px;
        padding: 1px 4px;
      }
      
      .trade-actions {
        flex-direction: column;
        gap: 2px;
      }
    }
  </style>
</head>
<body>
  <div class="theme-toggle" id="themeToggle" role="button" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
    <svg id="themeIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M12 3a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0V4a1 1 0 0 1 1-1zm7.07 3.07a1 1 0 0 1 0 1.414l-.707.707a1 1 0 1 1-1.414-1.414l.707-.707a1 1 0 0 1 1.414 0zm-14.14 0a1 1 0 0 1 1.414 0l.707.707A1 1 0 1 1 5.64 5.78l-.707-.707a1 1 0 0 1 0-1.414zM12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8zm-7 4a7 7 0 0 1 14 0 7 7 0 1 1-14 0z" />
    </svg>
  </div>

  <div class="container">
    <h1>üéØ –£–º–Ω—ã–π —Ç—Ä–µ–π–¥–∏–Ω–≥-–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</h1>

    <div class="grid">
      <div class="form-group">
        <label for="depositRub">–î–µ–ø–æ–∑–∏—Ç (—Ä—É–±):</label>
        <input type="number" id="depositRub" step="any" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 100000" value="100000"/>
      </div>
      <div class="form-group">
        <label for="depositUsd">–î–µ–ø–æ–∑–∏—Ç (USD):</label>
        <input type="number" id="depositUsd" step="any" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 1100" value="1050"/>
      </div>
    </div>

    <div class="form-group">
      <label for="riskPercent">–†–∏—Å–∫ –Ω–∞ —Å–¥–µ–ª–∫—É (%):</label>
      <input type="number" id="riskPercent" step="0.1" value="1.5" placeholder="1‚Äì2%" />
    </div>

    <hr class="divider">

    <div class="form-group">
      <label for="ticker">–¢–∏–∫–µ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, BTC/USDT):</label>
      <input type="text" id="ticker" placeholder="BTC/USDT" value="VELO/USDT"/>
    </div>
    <div class="form-group">
      <label for="entry">–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞:</label>
      <input type="number" id="entry" step="any" placeholder="68000" value="0.013393"/>
    </div>
    <div class="form-group">
      <label for="sl">–°—Ç–æ–ø-–ª–æ—Å—Å (SL):</label>
      <input type="number" id="sl" step="any" placeholder="70000" value="0.009876"/>
    </div>

    <h3>üéØ –¢–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç—ã (TP)</h3>
    <div class="grid">
      <div class="form-group">
        <label for="tp1_price">TP1:</label>
        <input type="number" id="tp1_price" step="any" placeholder="64000" value="0.020913"/>
        <input type="number" id="tp1_size" value="100" min="0" max="100"/>%
      </div>
      <div class="form-group">
        <label for="tp2_price">TP2:</label>
        <input type="number" id="tp2_price" step="any" placeholder="60000"/>
        <input type="number" id="tp2_size" value="0" min="0" max="100"/>%
      </div>
      <div class="form-group">
        <label for="tp3_price">TP3:</label>
        <input type="number" id="tp3_price" step="any" placeholder="55000"/>
        <input type="number" id="tp3_size" value="0" min="0" max="100"/>%
      </div>
      <div></div>
    </div>

    <div class="form-group">
      <label for="leverage">–ü–ª–µ—á–æ:</label>
      <select id="leverage">
        <option value="1">x1</option>
        <option value="2">x2</option>
        <option value="3">x3</option>
        <option value="4">x4</option>
        <option value="5">x5</option>
        <option value="10">x10</option>
        <option value="20">x20</option>
        <option value="50">x50</option>
        <option value="100" selected>x100</option>
      </select>
    </div>

    <button onclick="calculate()">üìä –†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>

    <div class="result" id="result" style="display:none;">
      <strong>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á—ë—Ç–∞:</strong>
      <table>
        <tr><td>–ú–æ–Ω–µ—Ç–∞:</td><td><span id="resultTicker"></span></td></tr>
        <tr><td>–†–∏—Å–∫ –≤ –¥–µ–Ω—å–≥–∞—Ö:</td><td><span id="moneyRisk"></span> —Ä—É–± / <span id="moneyRiskUsd"></span> USD</td></tr>
        <tr><td>–†–∏—Å–∫ (%) –æ—Ç —Ü–µ–Ω—ã:</td><td><span id="riskPercentVal"></span>%</td></tr>
        <tr><td>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–∏–±—ã–ª—å (%) –æ—Ç —Ü–µ–Ω—ã:</td><td><span id="profitPercentVal"></span>%</td></tr>
        <tr><td>R:R (Risk/Reward)</td><td><span id="rrValue"></span></td></tr>
        <tr><td>–ü–ª–µ—á–æ</td><td>x<span id="leverageUsed"></span></td></tr>
        <tr><td>–†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏:</td><td><span id="positionSize"></span> USDT</td></tr>
        <tr><td>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–∏–±—ã–ª—å:</td><td><span id="profitMoney"></span> —Ä—É–± (<span id="profitUsd"></span> USD)</td></tr>
        <tr><td>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–∏–±—ã–ª—å (% –æ—Ç –¥–µ–ø–æ–∑–∏—Ç–∞):</td><td><span id="profitPercentDeposit"></span>%</td></tr>
      </table>
      <button class="secondary" onclick="saveTrade()" style="margin-top:10px;">üìå –ó–∞–ø–∏—Å–∞—Ç—å —Å–¥–µ–ª–∫—É</button>
      
      <div class="stop-loss-section">
        <h4>‚ùå –ó–∞–∫—Ä—ã—Ç—å –ø–æ —Å—Ç–æ–ø-–ª–æ—Å—Å—É</h4>
        <p>–ï—Å–ª–∏ —Å–¥–µ–ª–∫–∞ –∑–∞–∫—Ä—ã–ª–∞—Å—å –ø–æ —Å—Ç–æ–ø—É, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —É–±—ã—Ç–æ–∫.</p>
        <button class="danger" onclick="recordStopLoss()" style="margin-top:10px;">üìâ –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —É–±—ã—Ç–æ–∫</button>
      </div>
    </div>

    <h2>üìã –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫</h2>
    <div class="buttons-row">
      <button class="secondary" onclick="exportToCSV()">üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</button>
      <button class="success" onclick="importFromCSV()" id="importBtn">üì• –ò–º–ø–æ—Ä—Ç –∏–∑ CSV</button>
      <button class="danger" onclick="clearHistory()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
    </div>
    
    <div class="history" id="history">
      <table id="historyTable">
        <thead>
          <tr>
            <th>–î–∞—Ç–∞</th>
            <th>–ú–æ–Ω–µ—Ç–∞</th>
            <th>–í—Ö–æ–¥ ‚Üí –í—ã—Ö–æ–¥</th>
            <th>R:R</th>
            <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
            <th>–¢–∏–ø –∑–∞–∫—Ä—ã—Ç–∏—è</th>
            <th>–ü–ª–µ—á–æ</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody id="historyBody">
          <tr><td colspan="8" class="empty">–ü–æ–∫–∞ –Ω–µ—Ç —Å–¥–µ–ª–æ–∫</td></tr>
        </tbody>
      </table>
    </div>

    <h3>üìà –ì—Ä–∞—Ñ–∏–∫ —Ä–æ—Å—Ç–∞ –¥–µ–ø–æ–∑–∏—Ç–∞</h3>
    <div class="chart-container">
      <canvas id="profitChart"></canvas>
    </div>

    <h3>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —Å–¥–µ–ª–∫–∞–º</h3>
    <div class="analytics" id="analytics">
      <table id="analyticsTable">
        <tr><td>–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫:</td><td id="totalTrades">0</td></tr>
        <tr><td>–°—Ä–µ–¥–Ω–∏–π R:R:</td><td id="avgRR">‚Äî</td></tr>
        <tr><td>–í—ã–∏–≥—Ä—ã—à–Ω—ã—Ö:</td><td id="winningTrades">0</td></tr>
        <tr><td>–ü—Ä–æ–∏–≥—Ä—ã—à–Ω—ã—Ö:</td><td id="losingTrades">0</td></tr>
        <tr><td>–û–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</td><td id="totalProfit">0 —Ä—É–±</td></tr>
      </table>
    </div>
  </div>

  <input type="file" id="importFile" accept=".csv" style="display: none;">

  <script>
    const USD_RATE = 95;
    let trades = JSON.parse(localStorage.getItem('advancedTrades')) || [];
    let profitChart = null;
    let currentCalculation = null;

    window.onload = function() {
      syncDeposits();
      updateHistory();
      updateAnalytics();
      renderChart();

      const isDark = localStorage.getItem('darkMode') === 'true';
      enableDarkMode(isDark);

      document.getElementById('importFile').addEventListener('change', handleImport);
    };

    function syncDeposits() {
      document.getElementById("depositRub").oninput = function() {
        const rub = parseFloat(this.value);
        if (!isNaN(rub)) {
          document.getElementById("depositUsd").value = (rub / USD_RATE).toFixed(2);
        }
      };
      document.getElementById("depositUsd").oninput = function() {
        const usd = parseFloat(this.value);
        if (!isNaN(usd)) {
          document.getElementById("depositRub").value = (usd * USD_RATE).toFixed(2);
        }
      };
    }

    function calculate() {
      const depositRub = parseFloat(document.getElementById("depositRub").value);
      const riskPercentOnTrade = parseFloat(document.getElementById("riskPercent").value);
      const entry = parseFloat(document.getElementById("entry").value);
      const sl = parseFloat(document.getElementById("sl").value);
      const leverage = parseInt(document.getElementById("leverage").value);
      const ticker = document.getElementById("ticker").value;

      const tp1 = { price: parseFloat(document.getElementById("tp1_price").value), size: parseFloat(document.getElementById("tp1_size").value) || 0 };
      const tp2 = { price: parseFloat(document.getElementById("tp2_price").value), size: parseFloat(document.getElementById("tp2_size").value) || 0 };
      const tp3 = { price: parseFloat(document.getElementById("tp3_price").value), size: parseFloat(document.getElementById("tp3_size").value) || 0 };

      if (!entry || !sl || !tp1.price) {
        alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ü–µ–Ω—É –≤—Ö–æ–¥–∞, SL –∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω TP.");
        return;
      }

      const totalTP = tp1.size + tp2.size + tp3.size;
      if (totalTP !== 100) {
        alert("–°—É–º–º–∞ TP –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 100%!");
        return;
      }

      // –†–∞—Å—á–µ—Ç –¥–µ–Ω–µ–∂–Ω–æ–≥–æ —Ä–∏—Å–∫–∞
      const moneyRiskRub = (depositRub * riskPercentOnTrade) / 100;
      const moneyRiskUsd = moneyRiskRub / USD_RATE;

      // –†–∞—Å—á–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–∞ —Ä–∏—Å–∫–∞ –æ—Ç —Ü–µ–Ω—ã
      let priceRiskPercent;
      if (entry > sl) {
        // –õ–æ–Ω–≥
        priceRiskPercent = ((entry - sl) / entry) * 100;
      } else {
        // –®–æ—Ä—Ç
        priceRiskPercent = ((sl - entry) / entry) * 100;
      }

      // –†–∞—Å—á–µ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –ø—Ä–∏–±—ã–ª–∏ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –æ—Ç —Ü–µ–Ω—ã
      let priceProfitPercent = 0;
      if (entry > sl) {
        // –õ–æ–Ω–≥
        if (tp1.price > entry) priceProfitPercent += ((tp1.price - entry) / entry) * (tp1.size / 100);
        if (tp2.price > entry) priceProfitPercent += ((tp2.price - entry) / entry) * (tp2.size / 100);
        if (tp3.price > entry) priceProfitPercent += ((tp3.price - entry) / entry) * (tp3.size / 100);
      } else {
        // –®–æ—Ä—Ç
        if (tp1.price < entry) priceProfitPercent += ((entry - tp1.price) / entry) * (tp1.size / 100);
        if (tp2.price < entry) priceProfitPercent += ((entry - tp2.price) / entry) * (tp2.size / 100);
        if (tp3.price < entry) priceProfitPercent += ((entry - tp3.price) / entry) * (tp3.size / 100);
      }
      priceProfitPercent *= 100;

      // –†–∞—Å—á–µ—Ç R:R
      const rr = priceProfitPercent / priceRiskPercent;

      // –ö–û–†–†–ï–ö–¢–ù–´–ô –†–ê–°–ß–ï–¢ –†–ê–ó–ú–ï–†–ê –ü–û–ó–ò–¶–ò–ò
      // –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ = —Ä–∏—Å–∫ –≤ –¥–µ–Ω—å–≥–∞—Ö / (—Ä–∏—Å–∫ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –æ—Ç —Ü–µ–Ω—ã / 100)
      const positionSizeUSDT = moneyRiskUsd / (priceRiskPercent / 100);
      
      // –ö–û–†–†–ï–ö–¢–ù–´–ô –†–ê–°–ß–ï–¢ –ü–†–ò–ë–´–õ–ò
      // –ü—Ä–∏–±—ã–ª—å = —Ä–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ * –ø—Ä–∏–±—ã–ª—å –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –æ—Ç —Ü–µ–Ω—ã * –ø–ª–µ—á–æ
      const profitUsd = positionSizeUSDT * (priceProfitPercent / 100) * leverage;
      const profitRub = profitUsd * USD_RATE;
      
      // –ü—Ä–∏–±—ã–ª—å –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –æ—Ç –¥–µ–ø–æ–∑–∏—Ç–∞
      const profitPercentDeposit = (profitRub / depositRub) * 100;

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞—Å—á–µ—Ç
      currentCalculation = {
        moneyRiskRub,
        moneyRiskUsd,
        priceRiskPercent,
        priceProfitPercent,
        rr: rr.toFixed(2),
        leverage,
        profitRub,
        profitUsd,
        profitPercentDeposit,
        positionSizeUSDT,
        tp1: tp1.price,
        tp2: tp2.price,
        tp3: tp3.price,
        tp1_size: tp1.size,
        tp2_size: tp2.size,
        tp3_size: tp3.size
      };

      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
      document.getElementById("resultTicker").textContent = ticker;
      document.getElementById("moneyRisk").textContent = moneyRiskRub.toFixed(2);
      document.getElementById("moneyRiskUsd").textContent = moneyRiskUsd.toFixed(2);
      document.getElementById("riskPercentVal").textContent = priceRiskPercent.toFixed(2);
      document.getElementById("profitPercentVal").textContent = priceProfitPercent.toFixed(2);
      document.getElementById("rrValue").textContent = rr.toFixed(2);
      document.getElementById("leverageUsed").textContent = leverage;
      document.getElementById("profitMoney").textContent = profitRub.toFixed(2);
      document.getElementById("profitUsd").textContent = profitUsd.toFixed(2);
      document.getElementById("profitPercentDeposit").textContent = profitPercentDeposit.toFixed(2);
      document.getElementById("positionSize").textContent = positionSizeUSDT.toFixed(2);

      const rrEl = document.getElementById("rrValue");
      rrEl.className = rr >= 2 ? "rr-good" : rr >= 1 ? "rr-warn" : "";

      document.getElementById("result").style.display = "block";
    }

    function saveTrade() {
      if (!currentCalculation) {
        alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ä–∞—Å—á—ë—Ç.");
        return;
      }

      const trade = {
        date: new Date().toLocaleString('ru-RU'),
        ticker: document.getElementById("resultTicker").textContent,
        entry: document.getElementById("entry").value,
        sl: document.getElementById("sl").value,
        tp1: document.getElementById("tp1_price").value,
        tp2: document.getElementById("tp2_price").value,
        tp3: document.getElementById("tp3_price").value,
        tp1_size: document.getElementById("tp1_size").value,
        tp2_size: document.getElementById("tp2_size").value,
        tp3_size: document.getElementById("tp3_size").value,
        leverage: document.getElementById("leverage").value,
        rr: currentCalculation.rr,
        profitMoney: currentCalculation.profitRub.toFixed(2),
        profitUsd: currentCalculation.profitUsd.toFixed(2),
        moneyRiskRub: currentCalculation.moneyRiskRub,
        potentialProfitRub: currentCalculation.profitRub,
        closedBy: 'tp'
      };

      trades.push(trade);
      localStorage.setItem('advancedTrades', JSON.stringify(trades));
      updateHistory();
      updateAnalytics();
      renderChart();
      alert("–°–¥–µ–ª–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!");
    }

    function recordStopLoss() {
      if (!currentCalculation) {
        alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ä–∞—Å—á—ë—Ç.");
        return;
      }

      const trade = {
        date: new Date().toLocaleString('ru-RU'),
        ticker: document.getElementById("resultTicker").textContent,
        entry: document.getElementById("entry").value,
        sl: document.getElementById("sl").value,
        tp1: document.getElementById("tp1_price").value,
        tp2: document.getElementById("tp2_price").value,
        tp3: document.getElementById("tp3_price").value,
        tp1_size: document.getElementById("tp1_size").value,
        tp2_size: document.getElementById("tp2_size").value,
        tp3_size: document.getElementById("tp3_size").value,
        leverage: document.getElementById("leverage").value,
        rr: currentCalculation.rr,
        profitMoney: (-currentCalculation.moneyRiskRub).toFixed(2),
        profitUsd: (-currentCalculation.moneyRiskUsd).toFixed(2),
        moneyRiskRub: currentCalculation.moneyRiskRub,
        potentialProfitRub: currentCalculation.profitRub,
        closedBy: 'sl'
      };

      trades.push(trade);
      localStorage.setItem('advancedTrades', JSON.stringify(trades));
      updateHistory();
      updateAnalytics();
      renderChart();
      alert(`–°–¥–µ–ª–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞ –ø–æ —Å—Ç–æ–ø-–ª–æ—Å—Å—É. –£–±—ã—Ç–æ–∫: ${currentCalculation.moneyRiskRub.toFixed(2)} —Ä—É–±`);
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    function deleteTrade(index) {
      if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å–¥–µ–ª–∫—É?")) {
        trades.splice(index, 1);
        localStorage.setItem('advancedTrades', JSON.stringify(trades));
        updateHistory();
        updateAnalytics();
        renderChart();
      }
    }

    function updateTradeCloseType(index, closeType) {
      const trade = trades[index];
      
      trade.closedBy = closeType;
      
      if (closeType === 'tp') {
        trade.profitMoney = trade.potentialProfitRub.toFixed(2);
      } else {
        trade.profitMoney = (-trade.moneyRiskRub).toFixed(2);
      }
      
      trade.profitUsd = (parseFloat(trade.profitMoney) / USD_RATE).toFixed(2);
      
      localStorage.setItem('advancedTrades', JSON.stringify(trades));
      updateHistory();
      updateAnalytics();
      renderChart();
    }

    function makeTickerEditable(cell, index) {
      const currentTicker = cell.textContent;
      cell.innerHTML = `<input type="text" value="${currentTicker}" class="editable-input" 
        onblur="updateTicker(this, ${index})" 
        onkeypress="if(event.keyCode==13) this.blur()">`;
      cell.firstChild.focus();
    }

    function updateTicker(input, index) {
      const newTicker = input.value.trim();
      if (newTicker) {
        trades[index].ticker = newTicker;
        localStorage.setItem('advancedTrades', JSON.stringify(trades));
        updateHistory();
      }
    }

    function updateHistory() {
      const tbody = document.getElementById("historyBody");
      if (trades.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty">–ü–æ–∫–∞ –Ω–µ—Ç —Å–¥–µ–ª–æ–∫</td></tr>';
        return;
      }

      tbody.innerHTML = '';
      trades.slice().reverse().forEach((t, originalIndex) => {
        const index = trades.length - 1 - originalIndex;
        const row = document.createElement("tr");
        
        const isProfit = parseFloat(t.profitMoney) >= 0;
        const profitClass = isProfit ? 'profit-positive' : 'profit-negative';
        
        let entryExitText = `${t.entry} ‚Üí `;
        if (t.closedBy === 'tp') {
          entryExitText += `TP: ${t.tp1}`;
          if (t.tp2 && parseFloat(t.tp2) > 0) entryExitText += `, ${t.tp2}`;
          if (t.tp3 && parseFloat(t.tp3) > 0) entryExitText += `, ${t.tp3}`;
        } else {
          entryExitText += `SL: ${t.sl}`;
        }

        row.innerHTML = `
          <td>${t.date}</td>
          <td class="editable" ondblclick="makeTickerEditable(this, ${index})">${t.ticker}</td>
          <td>${entryExitText}</td>
          <td class="${t.rr >= 2 ? 'rr-good' : t.rr >= 1 ? 'rr-warn' : ''}">${t.rr}</td>
          <td class="${profitClass}">${t.profitMoney} —Ä—É–±</td>
          <td>
            <select class="close-type-select" onchange="updateTradeCloseType(${index}, this.value)">
              <option value="tp" ${t.closedBy === 'tp' ? 'selected' : ''}>–ø–æ TP</option>
              <option value="sl" ${t.closedBy === 'sl' ? 'selected' : ''}>–ø–æ —Å—Ç–æ–ø—É</option>
            </select>
          </td>
          <td>x${t.leverage}</td>
          <td class="trade-actions">
            <button class="edit-trade" onclick="editTrade(${index})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–¥–µ–ª–∫—É">‚úé</button>
            <button class="delete-trade" onclick="deleteTrade(${index})" title="–£–¥–∞–ª–∏—Ç—å —Å–¥–µ–ª–∫—É">√ó</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function editTrade(index) {
      const trade = trades[index];
      
      document.getElementById("ticker").value = trade.ticker;
      document.getElementById("entry").value = trade.entry;
      document.getElementById("sl").value = trade.sl;
      document.getElementById("tp1_price").value = trade.tp1;
      document.getElementById("tp2_price").value = trade.tp2;
      document.getElementById("tp3_price").value = trade.tp3;
      document.getElementById("tp1_size").value = trade.tp1_size;
      document.getElementById("tp2_size").value = trade.tp2_size;
      document.getElementById("tp3_size").value = trade.tp3_size;
      document.getElementById("leverage").value = trade.leverage;
      
      calculate();
      document.getElementById("ticker").scrollIntoView({ behavior: 'smooth' });
      
      alert("–°–¥–µ–ª–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –≤ —Ñ–æ—Ä–º—É. –í—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å.");
    }

    function updateAnalytics() {
      if (trades.length === 0) {
        document.getElementById("totalTrades").textContent = "0";
        document.getElementById("avgRR").textContent = "‚Äî";
        document.getElementById("winningTrades").textContent = "0";
        document.getElementById("losingTrades").textContent = "0";
        document.getElementById("totalProfit").textContent = "0 —Ä—É–±";
        return;
      }

      const total = trades.length;
      const winning = trades.filter(t => parseFloat(t.profitMoney) > 0).length;
      const losing = trades.filter(t => parseFloat(t.profitMoney) < 0).length;
      const avgRR = trades.reduce((sum, t) => sum + parseFloat(t.rr), 0) / total;
      const totalProfitRub = trades.reduce((sum, t) => sum + parseFloat(t.profitMoney), 0);

      document.getElementById("totalTrades").textContent = total;
      document.getElementById("avgRR").textContent = avgRR.toFixed(2);
      document.getElementById("winningTrades").textContent = winning;
      document.getElementById("losingTrades").textContent = losing;
      document.getElementById("totalProfit").textContent = totalProfitRub.toFixed(2) + " —Ä—É–±";
    }

    function renderChart() {
      const ctx = document.getElementById('profitChart').getContext('2d');
      if (profitChart) profitChart.destroy();

      const labels = trades.map((_, i) => `–°–¥–µ–ª–∫–∞ ${i+1}`);
      let balance = parseFloat(document.getElementById("depositRub").value) || 100000;
      const data = [balance];

      trades.forEach(t => {
        balance += parseFloat(t.profitMoney);
        data.push(balance);
      });

      profitChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['–ù–∞—á–∞–ª–æ', ...labels],
          datasets: [{
            label: '–ë–∞–ª–∞–Ω—Å (—Ä—É–±)',
            data,
            borderColor: getComputedStyle(document.body).getPropertyValue('--btn-primary').trim() || '#3498db',
            backgroundColor: 'rgba(52, 152, 219, 0.1)',
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true }
          },
          scales: {
            y: { beginAtZero: false }
          }
        }
      });
    }

    function exportToCSV() {
      if (trades.length === 0) {
        alert("–ù–µ—á–µ–≥–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å.");
        return;
      }

      const headers = ["–î–∞—Ç–∞", "–ú–æ–Ω–µ—Ç–∞", "–í—Ö–æ–¥", "SL", "TP1", "TP2", "TP3", "–ü–ª–µ—á–æ", "R:R", "–†–µ–∑—É–ª—å—Ç–∞—Ç (—Ä—É–±)", "–¢–∏–ø –∑–∞–∫—Ä—ã—Ç–∏—è", "–†–∏—Å–∫ (—Ä—É–±)", "–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –ø—Ä–∏–±—ã–ª–∏ (—Ä—É–±)"];
      const rows = trades.map(t => [
        t.date,
        t.ticker,
        t.entry,
        t.sl,
        t.tp1,
        t.tp2,
        t.tp3,
        `x${t.leverage}`,
        t.rr,
        t.profitMoney,
        t.closedBy === 'sl' ? '–ø–æ —Å—Ç–æ–ø-–ª–æ—Å—Å—É' : '–ø–æ —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç—É',
        t.moneyRiskRub || '',
        t.potentialProfitRub || ''
      ]);

      const csvContent = [
        headers.join(";"),
        ...rows.map(row => row.join(";"))
      ].join("\n");

      const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", `trading_history_${new Date().toISOString().slice(0,10)}.csv`);
      link.click();
    }

    function importFromCSV() {
      document.getElementById('importFile').click();
    }

    function handleImport(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          let content = e.target.result;
          if (content.charCodeAt(0) === 0xFEFF) {
            content = content.slice(1);
          }
          
          const lines = content.split('\n');
          const importedTrades = [];
          
          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            const fields = line.split(';');
            if (fields.length >= 10) {
              const trade = {
                date: fields[0],
                ticker: fields[1],
                entry: fields[2],
                sl: fields[3],
                tp1: fields[4],
                tp2: fields[5],
                tp3: fields[6],
                leverage: fields[7].replace('x', ''),
                rr: fields[8],
                profitMoney: fields[9]
              };
              
              trade.closedBy = fields[10] && fields[10].includes('—Å—Ç–æ–ø') ? 'sl' : 'tp';
              trade.profitUsd = (parseFloat(trade.profitMoney) / USD_RATE).toFixed(2);
              
              if (fields.length >= 13) {
                trade.moneyRiskRub = parseFloat(fields[11]) || 0;
                trade.potentialProfitRub = parseFloat(fields[12]) || 0;
              }
              
              importedTrades.push(trade);
            }
          }
          
          if (importedTrades.length > 0) {
            if (confirm(`–ù–∞–π–¥–µ–Ω–æ ${importedTrades.length} —Å–¥–µ–ª–æ–∫. –ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é –∏—Å—Ç–æ—Ä–∏—é?`)) {
              trades = importedTrades;
              localStorage.setItem('advancedTrades', JSON.stringify(trades));
              updateHistory();
              updateAnalytics();
              renderChart();
              alert(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${importedTrades.length} —Å–¥–µ–ª–æ–∫!`);
            }
          } else {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Å–¥–µ–ª–∫–∏ –≤ —Ñ–∞–π–ª–µ.");
          }
        } catch (error) {
          alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ —Ñ–∞–π–ª–∞: " + error.message);
        }
        
        event.target.value = '';
      };
      
      reader.readAsText(file, 'utf-8');
    }

    function clearHistory() {
      if (confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –∏ –≥—Ä–∞—Ñ–∏–∫?")) {
        trades = [];
        localStorage.removeItem('advancedTrades');
        updateHistory();
        updateAnalytics();
        renderChart();
      }
    }

    function enableDarkMode(dark) {
      const body = document.body;
      const icon = document.getElementById('themeIcon');

      if (dark) {
        body.classList.add('dark-mode');
        icon.innerHTML = `<path d="M12 17a5 5 0 1 0 0-10 5 5 0 0 0 0 10zm0-12a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0V6a1 1 0 0 1 1-1zm0 13a1 1 0 0 1-1 1v1a1 1 0 1 1 2 0v-1a1 1 0 0 1-1-1zm7.07-7.07a1 1 0 0 1 0 1.414l-.707.707a1 1 0 1 1-1.414-1.414l.707-.707a1 1 0 0 1 1.414 0zm-14.14 0a1 1 0 0 1 1.414 0l.707.707A1 1 0 1 1 5.64 12.22l-.707-.707a1 1 0 0 1 0-1.414zm7.07 7.07a1 1 0 0 1-1.414 0l-.707-.707a1 1 0 1 1 1.414-1.414l.707.707a1 1 0 0 1 0 1.414zm0-14.14a1 1 0 0 1 1.414 0l.707.707A1 1 0 1 1 18.36 5.78l-.707-.707a1 1 0 0 1-1.414 0z"/>`;
      } else {
        body.classList.remove('dark-mode');
        icon.innerHTML = `<path d="M12 3a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0V4a1 1 0 0 1 1-1zm7.07 3.07a1 1 0 0 1 0 1.414l-.707.707a1 1 0 1 1-1.414-1.414l.707-.707a1 1 0 0 1 1.414 0zm-14.14 0a1 1 0 0 1 1.414 0l.707.707A1 1 0 1 1 5.64 5.78l-.707-.707a1 1 0 0 1 0-1.414zM12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8zm-7 4a7 7 0 0 1 14 0 7 7 0 1 1-14 0z" />`;
      }
      localStorage.setItem('darkMode', dark);
    }

    document.getElementById('themeToggle').addEventListener('click', function() {
      const isCurrentlyDark = document.body.classList.contains('dark-mode');
      enableDarkMode(!isCurrentlyDark);
    });
  </script>
</body>
</html>

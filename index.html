<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Risk/Reward calculator</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Все предыдущие стили остаются без изменений до секции авторизации */
    
    /* Новая компактная секция пользователя */
    .user-mini-card {
      position: fixed;
      top: 20px;
      left: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--bg-card);
      padding: 10px 15px;
      border-radius: 25px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      z-index: 1000;
      max-width: 250px;
      transition: all 0.3s ease;
    }

    .user-mini-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .user-mini-avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      border: 2px solid var(--border);
    }

    .user-mini-info {
      display: flex;
      flex-direction: column;
    }

    .user-mini-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--header);
    }

    .user-mini-id {
      font-size: 11px;
      color: #7f8c8d;
    }

    .user-mini-logout {
      background: transparent;
      border: none;
      color: #e74c3c;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      margin-left: 5px;
      transition: all 0.3s ease;
    }

    .user-mini-logout:hover {
      background: rgba(231, 76, 60, 0.1);
    }

    .sync-status-mini {
      position: fixed;
      top: 70px;
      left: 20px;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 10px;
      z-index: 1000;
      max-width: 250px;
    }

    .sync-success {
      color: #27ae60;
      background: rgba(39, 174, 96, 0.1);
    }

    .sync-error {
      color: #e74c3c;
      background: rgba(231, 76, 60, 0.1);
    }

    .sync-warning {
      color: #e67e22;
      background: rgba(230, 126, 34, 0.1);
    }

    .loading {
      opacity: 0.7;
    }

    /* Адаптивность для нового блока */
    @media (max-width: 768px) {
      .user-mini-card {
        top: 15px;
        left: 15px;
        max-width: 200px;
        padding: 8px 12px;
      }

      .user-mini-avatar {
        width: 30px;
        height: 30px;
      }

      .user-mini-name {
        font-size: 13px;
      }

      .user-mini-id {
        font-size: 10px;
      }

      .sync-status-mini {
        top: 60px;
        left: 15px;
        font-size: 10px;
      }

      .theme-toggle {
        top: 15px;
        right: 15px;
        width: 45px;
        height: 45px;
      }
    }

    @media (max-width: 480px) {
      .user-mini-card {
        top: 10px;
        left: 10px;
        max-width: 180px;
        padding: 6px 10px;
      }

      .user-mini-avatar {
        width: 25px;
        height: 25px;
      }

      .user-mini-name {
        font-size: 12px;
      }

      .user-mini-id {
        display: none; /* Скрываем ID на очень маленьких экранах */
      }

      .sync-status-mini {
        top: 50px;
        left: 10px;
      }
    }

    /* Остальные стили остаются без изменений */
    :root {
      --bg-body: #f7f9fc;
      --bg-card: #ffffff;
      --text: #333;
      --border: #b3d9ff;
      --header: #2c3e50;
      --btn-primary: #3498db;
      --btn-secondary: #95a5a6;
      --btn-danger: #e74c3c;
      --btn-success: #27ae60;
      --shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    body.dark-mode {
      --bg-body: #121212;
      --bg-card: #1e1e1e;
      --text: #e0e0e0;
      --border: #444;
      --header: #bbdefb;
      --btn-primary: #1976d2;
      --btn-secondary: #666;
      --btn-danger: #d32f2f;
      --btn-success: #2ecc71;
      --shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: var(--bg-body);
      color: var(--text);
      line-height: 1.6;
      transition: all 0.3s ease;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1, h2, h3, h4 {
      color: var(--header);
      margin: 20px 0 15px;
    }

    h1 {
      text-align: center;
      font-size: 2.2rem;
      margin-bottom: 30px;
    }

    h2 {
      font-size: 1.8rem;
      border-bottom: 2px solid var(--border);
      padding-bottom: 10px;
    }

    h3 {
      font-size: 1.4rem;
      margin-top: 25px;
    }

    /* Удалена старая секция авторизации */

    /* Формы */
    .form-section {
      background: var(--bg-card);
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 25px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 14px;
      color: var(--header);
    }

    input, select, button, textarea {
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      width: 100%;
      transition: all 0.3s ease;
      background: var(--bg-card);
      color: var(--text);
    }

    body.dark-mode input, 
    body.dark-mode select {
      background: #2d2d2d;
      border-color: #555;
      color: var(--text);
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--btn-primary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    button {
      background: var(--btn-primary);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      border-radius: 8px;
      margin: 5px 0;
      transition: all 0.3s ease;
      padding: 15px;
    }

    button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    button:active {
      transform: translateY(0);
    }

    button.secondary {
      background: var(--btn-secondary);
    }

    button.danger {
      background: var(--btn-danger);
    }

    button.success {
      background: var(--btn-success);
    }

    .divider {
      margin: 25px 0;
      border: none;
      border-top: 2px solid var(--border);
    }

    /* Результаты */
    .result, .history, .analytics {
      margin-top: 25px;
      padding: 25px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 15px;
      box-shadow: var(--shadow);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 14px;
      background: var(--bg-card);
    }

    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      background: var(--btn-primary);
      color: white;
      font-weight: 600;
    }

    .rr-good { color: #27ae60; font-weight: bold; }
    .rr-warn { color: #e67e22; font-weight: bold; }
    .profit-positive { color: #27ae60; font-weight: bold; }
    .profit-negative { color: #e74c3c; font-weight: bold; }

    .empty {
      text-align: center;
      color: #7f8c8d;
      font-style: italic;
      padding: 30px;
      font-size: 16px;
    }

    /* График */
    .chart-container {
      margin-top: 25px;
      height: 400px;
      background: var(--bg-card);
      padding: 20px;
      border-radius: 15px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    /* Кнопки действий */
    .buttons-row {
      display: flex;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .buttons-row button {
      flex: 1;
      min-width: 150px;
    }

    /* Тема */
    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--btn-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: var(--shadow);
      z-index: 1000;
      transition: all 0.3s ease;
      border: none;
    }

    .theme-toggle:hover {
      transform: scale(1.1);
    }

    .theme-toggle svg {
      width: 24px;
      height: 24px;
      fill: white;
    }

    /* Стоп-лосс секция */
    .stop-loss-section {
      margin-top: 20px;
      padding: 20px;
      background: #fdf2f2;
      border: 2px solid #e74c3c;
      border-radius: 10px;
    }

    body.dark-mode .stop-loss-section {
      background: #381a1a;
      border-color: #a0332c;
    }

    /* Мобильная история сделок */
    .mobile-trade-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .mobile-trade-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 15px;
    }

    .mobile-trade-ticker {
      font-weight: bold;
      font-size: 18px;
    }

    .mobile-trade-date {
      font-size: 14px;
      color: #7f8c8d;
    }

    .mobile-trade-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }

    .mobile-trade-detail {
      display: flex;
      flex-direction: column;
    }

    .mobile-trade-label {
      font-size: 12px;
      color: #7f8c8d;
      margin-bottom: 5px;
    }

    .mobile-trade-value {
      font-size: 16px;
      font-weight: 500;
    }

    .mobile-trade-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--border);
    }

    .mobile-trade-result {
      font-weight: bold;
      font-size: 18px;
    }

    .mobile-trade-buttons {
      display: flex;
      gap: 10px;
    }

    .delete-trade, .edit-trade {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 20px;
      padding: 8px;
      border-radius: 5px;
      transition: all 0.3s ease;
    }

    .delete-trade {
      color: #e74c3c;
    }

    .delete-trade:hover {
      background: rgba(231, 76, 60, 0.1);
    }

    .edit-trade {
      color: #3498db;
    }

    .edit-trade:hover {
      background: rgba(52, 152, 219, 0.1);
    }

    .close-type-select {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      background: var(--bg-card);
      color: var(--text);
    }

    /* Адаптивность */
    @media (max-width: 768px) {
      body {
        padding: 15px;
      }
      
      .container {
        padding: 0;
      }
      
      h1 {
        font-size: 1.8rem;
        margin-bottom: 20px;
      }
      
      .grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .form-section, .result, .history, .analytics {
        padding: 20px;
      }
      
      .buttons-row {
        flex-direction: column;
      }
      
      .buttons-row button {
        min-width: auto;
      }
      
      .chart-container {
        height: 300px;
        padding: 15px;
      }
      
      .theme-toggle {
        top: 15px;
        right: 15px;
        width: 45px;
        height: 45px;
      }
      
      .desktop-history {
        display: none;
      }
      
      .mobile-history {
        display: block;
      }

      .mobile-trade-details {
        grid-template-columns: 1fr;
      }
    }

    @media (min-width: 769px) {
      .mobile-history {
        display: none;
      }
      
      .desktop-history {
        display: block;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      .form-section, .result, .history, .analytics {
        padding: 15px;
      }
      
      input, select, button {
        padding: 10px 12px;
        font-size: 16px;
      }
      
      .chart-container {
        height: 250px;
      }
      
      .mobile-trade-actions {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }
      
      .mobile-trade-buttons {
        width: 100%;
        justify-content: space-between;
      }
    }

    /* Анимации */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.5s ease;
    }

    /* Улучшения для TP */
    .tp-section {
      background: rgba(52, 152, 219, 0.05);
      padding: 15px;
      border-radius: 10px;
      margin: 10px 0;
    }

    .tp-input-group {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: end;
    }

    .tp-input-group input[type="number"] {
      margin-bottom: 0;
    }

    .percentage-label {
      font-size: 12px;
      color: #7f8c8d;
      text-align: center;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <!-- Новая компактная карточка пользователя -->
  <div class="user-mini-card fade-in" id="userMiniCard" style="display: none;">
    <img id="userMiniAvatar" class="user-mini-avatar" src="" alt="Аватар">
    <div class="user-mini-info">
      <div class="user-mini-name" id="userMiniName"></div>
      <div class="user-mini-id" id="userMiniId"></div>
    </div>
    <button class="user-mini-logout" onclick="logout()" title="Выйти">🚪</button>
  </div>

  <!-- Статус синхронизации -->
  <div class="sync-status-mini" id="syncStatusMini"></div>

  <div class="theme-toggle" id="themeToggle" role="button" aria-label="Переключить тему">
    <svg id="themeIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M12 3a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0V4a1 1 0 0 1 1-1zm7.07 3.07a1 1 0 0 1 0 1.414l-.707.707a1 1 0 1 1-1.414-1.414l.707-.707a1 1 0 0 1 1.414 0zm-14.14 0a1 1 0 0 1 1.414 0l.707.707A1 1 0 1 1 5.64 5.78l-.707-.707a1 1 0 0 1 0-1.414zM12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8zm-7 4a7 7 0 0 1 14 0 7 7 0 1 1-14 0z" />
    </svg>
  </div>

  <div class="container">
    <!-- УДАЛЕНА СТАРАЯ СЕКЦИЯ АВТОРИЗАЦИИ -->

    <h1>🎯 Risk/Reward calculator</h1>

    <!-- Основная форма -->
    <div class="form-section fade-in">
      <div class="grid">
        <div class="form-group">
          <label for="depositRub">Депозит (руб):</label>
          <input type="number" id="depositRub" step="any" placeholder="Например: 100000" value="100000"/>
        </div>
        <div class="form-group">
          <label for="depositUsd">Депозит (USD):</label>
          <input type="number" id="depositUsd" step="any" placeholder="Например: 1100" value="1050"/>
        </div>
      </div>

      <div class="form-group">
        <label for="riskPercent">Риск на сделку (%):</label>
        <input type="number" id="riskPercent" step="0.1" value="1.5" placeholder="1–2%" />
      </div>

      <hr class="divider">

      <div class="form-group">
        <label for="ticker">Тикер (например, BTC/USDT):</label>
        <input type="text" id="ticker" placeholder="BTC/USDT" value="VELO/USDT"/>
      </div>
      
      <div class="grid">
        <div class="form-group">
          <label for="entry">Цена входа:</label>
          <input type="number" id="entry" step="any" placeholder="68000" value="0.013393"/>
        </div>
        <div class="form-group">
          <label for="sl">Стоп-лосс (SL):</label>
          <input type="number" id="sl" step="any" placeholder="70000" value="0.009876"/>
        </div>
      </div>

      <h3>🎯 Тейк-профиты (TP)</h3>
      
      <div class="tp-section">
        <div class="tp-input-group">
          <div class="form-group">
            <label for="tp1_price">TP1 Цена:</label>
            <input type="number" id="tp1_price" step="any" placeholder="64000" value="0.020913"/>
          </div>
          <div class="form-group">
            <label for="tp1_size">% объема:</label>
            <input type="number" id="tp1_size" value="100" min="0" max="100"/>
          </div>
        </div>
      </div>

      <div class="tp-section">
        <div class="tp-input-group">
          <div class="form-group">
            <label for="tp2_price">TP2 Цена:</label>
            <input type="number" id="tp2_price" step="any" placeholder="60000"/>
          </div>
          <div class="form-group">
            <label for="tp2_size">% объема:</label>
            <input type="number" id="tp2_size" value="0" min="0" max="100"/>
          </div>
        </div>
      </div>

      <div class="tp-section">
        <div class="tp-input-group">
          <div class="form-group">
            <label for="tp3_price">TP3 Цена:</label>
            <input type="number" id="tp3_price" step="any" placeholder="55000"/>
          </div>
          <div class="form-group">
            <label for="tp3_size">% объема:</label>
            <input type="number" id="tp3_size" value="0" min="0" max="100"/>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="leverage">Плечо:</label>
        <select id="leverage">
          <option value="1">x1</option>
          <option value="2">x2</option>
          <option value="3">x3</option>
          <option value="4">x4</option>
          <option value="5">x5</option>
          <option value="10">x10</option>
          <option value="20">x20</option>
          <option value="50">x50</option>
          <option value="100" selected>x100</option>
        </select>
      </div>

      <button onclick="calculate()">📊 Рассчитать</button>
    </div>

    <!-- Результаты расчета -->
    <div class="result fade-in" id="result" style="display:none;">
      <h3>📈 Результаты расчёта</h3>
      <table>
        <tr><td>Монета:</td><td><span id="resultTicker"></span></td></tr>
        <tr><td>Риск в деньгах:</td><td><span id="moneyRisk"></span> руб / <span id="moneyRiskUsd"></span> USD</td></tr>
        <tr><td>Риск (%) от цены:</td><td><span id="riskPercentVal"></span>%</td></tr>
        <tr><td>Потенциальная прибыль (%):</td><td><span id="profitPercentVal"></span>%</td></tr>
        <tr><td>R:R (Risk/Reward)</td><td><span id="rrValue"></span></td></tr>
        <tr><td>Плечо</td><td>x<span id="leverageUsed"></span></td></tr>
        <tr><td>Размер позиции:</td><td><span id="positionSize"></span> USDT</td></tr>
        <tr><td>Потенциальная прибыль:</td><td><span id="profitMoney"></span> руб (<span id="profitUsd"></span> USD)</td></tr>
        <tr><td>Прибыль (% от депозита):</td><td><span id="profitPercentDeposit"></span>%</td></tr>
      </table>
      
      <div class="buttons-row">
        <button class="success" onclick="saveTrade()">📌 Записать сделку</button>
      </div>
      
      <div class="stop-loss-section">
        <h4>❌ Закрыть по стоп-лоссу</h4>
        <p>Если сделка закрылась по стопу, нажмите кнопку ниже, чтобы зафиксировать убыток.</p>
        <button class="danger" onclick="recordStopLoss()">📉 Зафиксировать убыток</button>
      </div>
    </div>

    <!-- История сделок -->
    <div class="history fade-in">
      <h2>📋 История сделок</h2>
      <div class="buttons-row">
        <button class="secondary" onclick="exportToCSV()">📤 Экспорт в CSV</button>
        <button class="success" onclick="importFromCSV()" id="importBtn">📥 Импорт из CSV</button>
        <button class="danger" onclick="clearHistory()">🗑️ Очистить историю</button>
      </div>
      
      <!-- Десктоп версия -->
      <div class="desktop-history">
        <table id="historyTable">
          <thead>
            <tr>
              <th>Дата</th>
              <th>Монета</th>
              <th>Вход → Выход</th>
              <th>R:R</th>
              <th>Результат</th>
              <th>Тип закрытия</th>
              <th>Плечо</th>
              <th>Действия</th>
            </tr>
          </thead>
          <tbody id="historyBody">
            <tr><td colspan="8" class="empty">Пока нет сделок</td></tr>
          </tbody>
        </table>
      </div>
      
      <!-- Мобильная версия -->
      <div class="mobile-history" id="mobileHistory">
        <div class="empty">Пока нет сделок</div>
      </div>
    </div>

    <!-- График и аналитика -->
    <div class="chart-container fade-in">
      <canvas id="profitChart"></canvas>
    </div>

    <div class="analytics fade-in" id="analytics">
      <h3>📊 Аналитика по сделкам</h3>
      <table id="analyticsTable">
        <tr><td>Всего сделок:</td><td id="totalTrades">0</td></tr>
        <tr><td>Средний R:R:</td><td id="avgRR">—</td></tr>
        <tr><td>Выигрышных:</td><td id="winningTrades">0</td></tr>
        <tr><td>Проигрышных:</td><td id="losingTrades">0</td></tr>
        <tr><td>Общий результат:</td><td id="totalProfit">0 руб</td></tr>
      </table>
    </div>
  </div>

  <input type="file" id="importFile" accept=".csv" style="display: none;">

  <script>
    // Конфигурация
    const SERVER_URL = 'https://trading-app-backend-cj71.onrender.com/api';
    const USD_RATE = 95;
    const BOT_USERNAME = 'rrcalc_bot';
    
    // Глобальные переменные
    let trades = [];
    let profitChart = null;
    let currentCalculation = null;
    let currentUser = null;
    let isOnline = false;
    let isTelegramWebApp = false;

    // Инициализация приложения
    document.addEventListener('DOMContentLoaded', function() {
      initApp();
    });

    async function initApp() {
      // Проверяем, открыто ли в Telegram Web App
      checkTelegramWebApp();
      
      syncDeposits();
      
      // Проверяем авторизацию
      const savedUser = localStorage.getItem('telegramUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showUserMiniInfo(currentUser);
        await loadTradesFromServer();
      } else {
        // Если не авторизован и не в Telegram, показываем инструкцию
        if (!isTelegramWebApp) {
          showTelegramInstruction();
        }
      }

      updateHistory();
      updateAnalytics();
      renderChart();

      const isDark = localStorage.getItem('darkMode') === 'true';
      enableDarkMode(isDark);

      document.getElementById('importFile').addEventListener('change', handleImport);
    }

    // Проверка Telegram Web App
    function checkTelegramWebApp() {
      if (window.Telegram && window.Telegram.WebApp) {
        isTelegramWebApp = true;
        const tg = window.Telegram.WebApp;
        
        // Инициализируем Telegram Web App
        tg.ready();
        tg.expand();
        
        // Проверяем данные пользователя
        const user = tg.initDataUnsafe?.user;
        if (user) {
          const telegramUser = {
            id: user.id.toString(),
            first_name: user.first_name,
            username: user.username,
            photo_url: user.photo_url,
            language_code: user.language_code,
            is_premium: user.is_premium || false
          };
          
          handleTelegramAuth(telegramUser);
        }
        
        // Настраиваем внешний вид под Telegram
        setupTelegramTheme(tg);
      }
    }

    function setupTelegramTheme(tg) {
      tg.setHeaderColor('#0088cc');
      tg.setBackgroundColor('#f7f9fc');
      
      tg.onEvent('themeChanged', () => {
        const isDark = tg.colorScheme === 'dark';
        enableDarkMode(isDark);
      });
      
      const isDark = tg.colorScheme === 'dark';
      enableDarkMode(isDark);
    }

    function showTelegramInstruction() {
      // Создаем временное уведомление
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #0088cc;
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 1001;
        text-align: center;
        max-width: 90%;
      `;
      notification.innerHTML = `
        <div style="margin-bottom: 10px; font-weight: bold;">Откройте в Telegram для полного доступа</div>
        <a href="https://t.me/${BOT_USERNAME}" target="_blank" style="color: white; text-decoration: underline;">
          Открыть в @${BOT_USERNAME}
        </a>
        <button onclick="this.parentElement.remove()" style="background: transparent; border: none; color: white; margin-left: 15px; cursor: pointer;">✕</button>
      `;
      document.body.appendChild(notification);
      
      // Автоматически скрываем через 10 секунд
      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
        }
      }, 10000);
    }

    // Функции авторизации
    function handleTelegramAuth(user) {
      currentUser = user;
      localStorage.setItem('telegramUser', JSON.stringify(user));
      showUserMiniInfo(user);
      
      saveUserToServer(user);
      loadTradesFromServer();
    }

    function showUserMiniInfo(user) {
      const userMiniCard = document.getElementById('userMiniCard');
      userMiniCard.style.display = 'flex';
      
      document.getElementById('userMiniName').textContent = user.first_name;
      document.getElementById('userMiniId').textContent = `ID: ${user.id}`;
      
      if (user.photo_url) {
        document.getElementById('userMiniAvatar').src = user.photo_url;
      } else {
        document.getElementById('userMiniAvatar').src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzUiIGhlaWdodD0iMzUiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMjUiIGZpbGw9IiMzNDk4REIiLz4KPHN2ZyB4PSIxMi41IiB5PSIxMi41IiB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDMTMuMSAyIDE0IDIuOSAxNCA0QzE0IDUuMSAxMy4xIDYgMTIgNkMxMC45IDYgMTAgNS4xIDEwIDRDMTAgMi45IDEwLjkgMiAxMiAyWk0yMSAxNkMyMSAxNC43IDIwLjEgMTMuNiAxOC45IDEzLjNDMTguNSAxMi45IDE3LjggMTIuNyAxNy4yIDEyLjdDMTYuNiAxMi43IDE1LjkgMTIuOSAxNS41IDEzLjNDMTQuOSAxMy42IDE0IDE0LjcgMTQgMTZWMjFIMjFWMTZaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4KPC9zdmc+';
      }
    }

    function logout() {
      if (confirm("Выйти из аккаунта?")) {
        currentUser = null;
        localStorage.removeItem('telegramUser');
        trades = [];
        
        document.getElementById('userMiniCard').style.display = 'none';
        updateSyncStatusMini('', '');
        
        if (isTelegramWebApp) {
          // В режиме Telegram просто обновляем страницу
          location.reload();
        } else {
          showTelegramInstruction();
        }
        
        updateHistory();
        updateAnalytics();
        renderChart();
      }
    }

    // API функции
    async function saveUserToServer(user) {
      try {
        const response = await fetch(`${SERVER_URL}/users`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            telegramId: user.id,
            firstName: user.first_name,
            username: user.username,
            photoUrl: user.photo_url,
            languageCode: user.language_code,
            isPremium: user.is_premium
          })
        });
        
        if (!response.ok) throw new Error('Ошибка сохранения пользователя');
        console.log('Пользователь сохранен на сервере');
      } catch (error) {
        console.error('Ошибка при сохранении пользователя:', error);
      }
    }

    async function saveTradesToServer(action = 'replace') {
      if (!currentUser) return;
      
      try {
        updateSyncStatusMini('Синхронизация...', 'loading');
        
        const url = action === 'add' ? `${SERVER_URL}/trades/add` : `${SERVER_URL}/trades`;
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            telegramId: currentUser.id,
            trades: trades,
            action: action
          })
        });
        
        if (!response.ok) throw new Error('Ошибка сохранения сделок');
        
        const result = await response.json();
        updateSyncStatusMini('Данные синхронизированы', 'success');
        isOnline = true;
        return result;
      } catch (error) {
        console.error('Ошибка при сохранении сделок:', error);
        updateSyncStatusMini('Ошибка синхронизации', 'error');
        isOnline = false;
        localStorage.setItem('trades_backup', JSON.stringify(trades));
      }
    }

    async function loadTradesFromServer() {
      if (!currentUser) return;
      
      try {
        updateSyncStatusMini('Загрузка данных...', 'loading');
        
        const response = await fetch(`${SERVER_URL}/trades/${currentUser.id}`);
        
        if (!response.ok) {
          const backup = localStorage.getItem('trades_backup');
          if (backup) {
            trades = JSON.parse(backup);
            updateSyncStatusMini('Загружено из резервной копии', 'warning');
          } else {
            trades = [];
            updateSyncStatusMini('Нет данных на сервере', 'warning');
          }
          return;
        }
        
        const data = await response.json();
        trades = data.trades || [];
        updateSyncStatusMini('Данные загружены', 'success');
        isOnline = true;
        
        updateHistory();
        updateAnalytics();
        renderChart();
      } catch (error) {
        console.error('Ошибка при загрузке сделок:', error);
        
        const backup = localStorage.getItem('trades_backup');
        if (backup) {
          trades = JSON.parse(backup);
          updateSyncStatusMini('Загружено из резервной копии', 'warning');
        } else {
          trades = [];
          updateSyncStatusMini('Офлайн режим', 'error');
        }
        isOnline = false;
        
        updateHistory();
        updateAnalytics();
        renderChart();
      }
    }

    function updateSyncStatusMini(message, type) {
      const statusElement = document.getElementById('syncStatusMini');
      statusElement.textContent = message;
      statusElement.className = 'sync-status-mini';
      
      if (type === 'success') statusElement.classList.add('sync-success');
      if (type === 'error') statusElement.classList.add('sync-error');
      if (type === 'warning') statusElement.classList.add('sync-warning');
      if (type === 'loading') statusElement.classList.add('loading');
      
      // Автоматически скрываем успешные сообщения через 3 секунды
      if (type === 'success') {
        setTimeout(() => {
          if (statusElement.textContent === message) {
            statusElement.textContent = '';
            statusElement.className = 'sync-status-mini';
          }
        }, 3000);
      }
    }

    // Остальные функции (syncDeposits, calculate, saveTrade, recordStopLoss, 
    // deleteTrade, updateTradeCloseType, updateHistory, editTrade, updateAnalytics, 
    // renderChart, generateId, exportToCSV, importFromCSV, handleImport, clearHistory, 
    // enableDarkMode) остаются БЕЗ ИЗМЕНЕНИЙ

    // Основные функции калькулятора
    function syncDeposits() {
      const depositRub = document.getElementById("depositRub");
      const depositUsd = document.getElementById("depositUsd");
      
      depositRub.addEventListener('input', function() {
        const rub = parseFloat(this.value);
        if (!isNaN(rub)) {
          depositUsd.value = (rub / USD_RATE).toFixed(2);
        }
      });
      
      depositUsd.addEventListener('input', function() {
        const usd = parseFloat(this.value);
        if (!isNaN(usd)) {
          depositRub.value = (usd * USD_RATE).toFixed(2);
        }
      });
    }

    function calculate() {
      try {
        const depositRub = parseFloat(document.getElementById("depositRub").value);
        const riskPercentOnTrade = parseFloat(document.getElementById("riskPercent").value);
        const entry = parseFloat(document.getElementById("entry").value);
        const sl = parseFloat(document.getElementById("sl").value);
        const leverage = parseInt(document.getElementById("leverage").value);
        const ticker = document.getElementById("ticker").value;

        const tp1 = { 
          price: parseFloat(document.getElementById("tp1_price").value) || 0, 
          size: parseFloat(document.getElementById("tp1_size").value) || 0 
        };
        const tp2 = { 
          price: parseFloat(document.getElementById("tp2_price").value) || 0, 
          size: parseFloat(document.getElementById("tp2_size").value) || 0 
        };
        const tp3 = { 
          price: parseFloat(document.getElementById("tp3_price").value) || 0, 
          size: parseFloat(document.getElementById("tp3_size").value) || 0 
        };

        if (!entry || !sl) {
          alert("Заполните цену входа и стоп-лосс.");
          return;
        }

        const totalTP = tp1.size + tp2.size + tp3.size;
        if (totalTP !== 100) {
          alert("Сумма TP должна быть 100%!");
          return;
        }

        // Расчет денежного риска
        const moneyRiskRub = (depositRub * riskPercentOnTrade) / 100;
        const moneyRiskUsd = moneyRiskRub / USD_RATE;

        // Расчет процента риска от цены
        let priceRiskPercent;
        if (entry > sl) {
          priceRiskPercent = ((entry - sl) / entry) * 100;
        } else {
          priceRiskPercent = ((sl - entry) / entry) * 100;
        }

        // Расчет потенциальной прибыли в процентах от цены
        let priceProfitPercent = 0;
        if (entry > sl) {
          if (tp1.price > entry) priceProfitPercent += ((tp1.price - entry) / entry) * (tp1.size / 100);
          if (tp2.price > entry) priceProfitPercent += ((tp2.price - entry) / entry) * (tp2.size / 100);
          if (tp3.price > entry) priceProfitPercent += ((tp3.price - entry) / entry) * (tp3.size / 100);
        } else {
          if (tp1.price < entry) priceProfitPercent += ((entry - tp1.price) / entry) * (tp1.size / 100);
          if (tp2.price < entry) priceProfitPercent += ((entry - tp2.price) / entry) * (tp2.size / 100);
          if (tp3.price < entry) priceProfitPercent += ((entry - tp3.price) / entry) * (tp3.size / 100);
        }
        priceProfitPercent *= 100;

        // Расчет R:R
        const rr = priceProfitPercent / priceRiskPercent;

        // Расчет размера позиции
        const positionSizeUSDT = moneyRiskUsd / (priceRiskPercent / 100);
        
        // Расчет прибыли
        const profitUsd = positionSizeUSDT * (priceProfitPercent / 100) * leverage;
        const profitRub = profitUsd * USD_RATE;
        
        // Прибыль в процентах от депозита
        const profitPercentDeposit = (profitRub / depositRub) * 100;

        // Сохраняем расчет
        currentCalculation = {
          moneyRiskRub,
          moneyRiskUsd,
          priceRiskPercent,
          priceProfitPercent,
          rr: rr.toFixed(2),
          leverage,
          profitRub,
          profitUsd,
          profitPercentDeposit,
          positionSizeUSDT,
          tp1: tp1.price,
          tp2: tp2.price,
          tp3: tp3.price,
          tp1_size: tp1.size,
          tp2_size: tp2.size,
          tp3_size: tp3.size
        };

        // Обновляем интерфейс
        document.getElementById("resultTicker").textContent = ticker;
        document.getElementById("moneyRisk").textContent = moneyRiskRub.toFixed(2);
        document.getElementById("moneyRiskUsd").textContent = moneyRiskUsd.toFixed(2);
        document.getElementById("riskPercentVal").textContent = priceRiskPercent.toFixed(2);
        document.getElementById("profitPercentVal").textContent = priceProfitPercent.toFixed(2);
        document.getElementById("rrValue").textContent = rr.toFixed(2);
        document.getElementById("leverageUsed").textContent = leverage;
        document.getElementById("profitMoney").textContent = profitRub.toFixed(2);
        document.getElementById("profitUsd").textContent = profitUsd.toFixed(2);
        document.getElementById("profitPercentDeposit").textContent = profitPercentDeposit.toFixed(2);
        document.getElementById("positionSize").textContent = positionSizeUSDT.toFixed(2);

        const rrEl = document.getElementById("rrValue");
        rrEl.className = rr >= 2 ? "rr-good" : rr >= 1 ? "rr-warn" : "";

        document.getElementById("result").style.display = "block";
      } catch (error) {
        alert("Ошибка при расчете: " + error.message);
        console.error(error);
      }
    }

    // Функции работы со сделками
    async function saveTrade() {
      if (!currentUser) {
        alert('Сначала войдите в систему');
        return;
      }

      if (!currentCalculation) {
        alert("Сначала выполните расчёт.");
        return;
      }

      try {
        const trade = {
          id: generateId(),
          date: new Date().toLocaleString('ru-RU'),
          timestamp: new Date().toISOString(),
          ticker: document.getElementById("resultTicker").textContent,
          entry: parseFloat(document.getElementById("entry").value),
          sl: parseFloat(document.getElementById("sl").value),
          tp1: parseFloat(document.getElementById("tp1_price").value) || 0,
          tp2: parseFloat(document.getElementById("tp2_price").value) || 0,
          tp3: parseFloat(document.getElementById("tp3_price").value) || 0,
          tp1_size: parseFloat(document.getElementById("tp1_size").value) || 0,
          tp2_size: parseFloat(document.getElementById("tp2_size").value) || 0,
          tp3_size: parseFloat(document.getElementById("tp3_size").value) || 0,
          leverage: parseInt(document.getElementById("leverage").value),
          rr: currentCalculation.rr,
          profitMoney: currentCalculation.profitRub.toFixed(2),
          profitUsd: currentCalculation.profitUsd.toFixed(2),
          moneyRiskRub: currentCalculation.moneyRiskRub,
          potentialProfitRub: currentCalculation.profitRub,
          closedBy: 'tp'
        };

        trades.push(trade);
        await saveTradesToServer();
        
        updateHistory();
        updateAnalytics();
        renderChart();
        
        // Показываем уведомление в Telegram Web App
        if (isTelegramWebApp && window.Telegram.WebApp.showPopup) {
          window.Telegram.WebApp.showPopup({
            title: 'Сделка сохранена!',
            message: `Тикер: ${trade.ticker}\nПотенциальная прибыль: ${trade.profitMoney} руб`,
            buttons: [{ type: 'ok' }]
          });
        } else {
          alert("Сделка сохранена!");
        }
      } catch (error) {
        alert("Ошибка при сохранении сделки: " + error.message);
        console.error(error);
      }
    }

    async function recordStopLoss() {
      if (!currentUser) {
        alert('Сначала войдите в систему');
        return;
      }

      if (!currentCalculation) {
        alert("Сначала выполните расчёт.");
        return;
      }

      try {
        const trade = {
          id: generateId(),
          date: new Date().toLocaleString('ru-RU'),
          timestamp: new Date().toISOString(),
          ticker: document.getElementById("resultTicker").textContent,
          entry: parseFloat(document.getElementById("entry").value),
          sl: parseFloat(document.getElementById("sl").value),
          tp1: parseFloat(document.getElementById("tp1_price").value) || 0,
          tp2: parseFloat(document.getElementById("tp2_price").value) || 0,
          tp3: parseFloat(document.getElementById("tp3_price").value) || 0,
          tp1_size: parseFloat(document.getElementById("tp1_size").value) || 0,
          tp2_size: parseFloat(document.getElementById("tp2_size").value) || 0,
          tp3_size: parseFloat(document.getElementById("tp3_size").value) || 0,
          leverage: parseInt(document.getElementById("leverage").value),
          rr: currentCalculation.rr,
          profitMoney: (-currentCalculation.moneyRiskRub).toFixed(2),
          profitUsd: (-currentCalculation.moneyRiskUsd).toFixed(2),
          moneyRiskRub: currentCalculation.moneyRiskRub,
          potentialProfitRub: currentCalculation.profitRub,
          closedBy: 'sl'
        };

        trades.push(trade);
        await saveTradesToServer();
        
        updateHistory();
        updateAnalytics();
        renderChart();
        
        // Показываем уведомление в Telegram Web App
        if (isTelegramWebApp && window.Telegram.WebApp.showPopup) {
          window.Telegram.WebApp.showPopup({
            title: 'Стоп-лосс зафиксирован',
            message: `Тикер: ${trade.ticker}\nУбыток: ${trade.profitMoney} руб`,
            buttons: [{ type: 'ok' }]
          });
        } else {
          alert(`Сделка закрыта по стоп-лоссу. Убыток: ${currentCalculation.moneyRiskRub.toFixed(2)} руб`);
        }
      } catch (error) {
        alert("Ошибка при записи стоп-лосса: " + error.message);
        console.error(error);
      }
    }

    async function deleteTrade(index) {
      if (confirm("Удалить эту сделку?")) {
        trades.splice(index, 1);
        await saveTradesToServer();
        updateHistory();
        updateAnalytics();
        renderChart();
      }
    }

    async function updateTradeCloseType(index, closeType) {
      const trade = trades[index];
      trade.closedBy = closeType;
      
      if (closeType === 'tp') {
        trade.profitMoney = trade.potentialProfitRub.toFixed(2);
      } else {
        trade.profitMoney = (-trade.moneyRiskRub).toFixed(2);
      }
      
      trade.profitUsd = (parseFloat(trade.profitMoney) / USD_RATE).toFixed(2);
      await saveTradesToServer();
      updateHistory();
      updateAnalytics();
      renderChart();
    }

    // Функции интерфейса
    function updateHistory() {
      const tbody = document.getElementById("historyBody");
      const mobileHistory = document.getElementById("mobileHistory");
      
      if (trades.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty">Пока нет сделок</td></tr>';
        mobileHistory.innerHTML = '<div class="empty">Пока нет сделок</div>';
        return;
      }

      // Десктоп версия
      tbody.innerHTML = '';
      trades.forEach((t, index) => {
        const row = document.createElement("tr");
        const isProfit = parseFloat(t.profitMoney) >= 0;
        const profitClass = isProfit ? 'profit-positive' : 'profit-negative';
        
        let entryExitText = `${t.entry} → `;
        if (t.closedBy === 'tp') {
          entryExitText += `TP: ${t.tp1}`;
          if (t.tp2 && parseFloat(t.tp2) > 0) entryExitText += `, ${t.tp2}`;
          if (t.tp3 && parseFloat(t.tp3) > 0) entryExitText += `, ${t.tp3}`;
        } else {
          entryExitText += `SL: ${t.sl}`;
        }

        row.innerHTML = `
          <td>${t.date}</td>
          <td>${t.ticker}</td>
          <td>${entryExitText}</td>
          <td class="${t.rr >= 2 ? 'rr-good' : t.rr >= 1 ? 'rr-warn' : ''}">${t.rr}</td>
          <td class="${profitClass}">${t.profitMoney} руб</td>
          <td>
            <select class="close-type-select" onchange="updateTradeCloseType(${index}, this.value)">
              <option value="tp" ${t.closedBy === 'tp' ? 'selected' : ''}>по TP</option>
              <option value="sl" ${t.closedBy === 'sl' ? 'selected' : ''}>по стопу</option>
            </select>
          </td>
          <td>x${t.leverage}</td>
          <td>
            <button class="edit-trade" onclick="editTrade(${index})" title="Редактировать">✎</button>
            <button class="delete-trade" onclick="deleteTrade(${index})" title="Удалить">×</button>
          </td>
        `;
        tbody.appendChild(row);
      });

      // Мобильная версия
      mobileHistory.innerHTML = '';
      trades.forEach((t, index) => {
        const isProfit = parseFloat(t.profitMoney) >= 0;
        const profitClass = isProfit ? 'profit-positive' : 'profit-negative';
        const profitSign = isProfit ? '+' : '';
        
        let entryExitText = `${t.entry} → `;
        if (t.closedBy === 'tp') {
          entryExitText += `TP: ${t.tp1}`;
          if (t.tp2 && parseFloat(t.tp2) > 0) entryExitText += `, ${t.tp2}`;
          if (t.tp3 && parseFloat(t.tp3) > 0) entryExitText += `, ${t.tp3}`;
        } else {
          entryExitText += `SL: ${t.sl}`;
        }

        const card = document.createElement("div");
        card.className = "mobile-trade-card";
        card.innerHTML = `
          <div class="mobile-trade-header">
            <div class="mobile-trade-ticker">${t.ticker}</div>
            <div class="mobile-trade-date">${t.date}</div>
          </div>
          <div class="mobile-trade-details">
            <div class="mobile-trade-detail">
              <div class="mobile-trade-label">Вход → Выход</div>
              <div class="mobile-trade-value">${entryExitText}</div>
            </div>
            <div class="mobile-trade-detail">
              <div class="mobile-trade-label">R:R</div>
              <div class="mobile-trade-value ${t.rr >= 2 ? 'rr-good' : t.rr >= 1 ? 'rr-warn' : ''}">${t.rr}</div>
            </div>
            <div class="mobile-trade-detail">
              <div class="mobile-trade-label">Плечо</div>
              <div class="mobile-trade-value">x${t.leverage}</div>
            </div>
            <div class="mobile-trade-detail">
              <div class="mobile-trade-label">Тип закрытия</div>
              <div class="mobile-trade-value">
                <select class="close-type-select" onchange="updateTradeCloseType(${index}, this.value)">
                  <option value="tp" ${t.closedBy === 'tp' ? 'selected' : ''}>по TP</option>
                  <option value="sl" ${t.closedBy === 'sl' ? 'selected' : ''}>по стопу</option>
                </select>
              </div>
            </div>
          </div>
          <div class="mobile-trade-actions">
            <div class="mobile-trade-result ${profitClass}">${profitSign}${t.profitMoney} руб</div>
            <div class="mobile-trade-buttons">
              <button class="edit-trade" onclick="editTrade(${index})" title="Редактировать">✎</button>
              <button class="delete-trade" onclick="deleteTrade(${index})" title="Удалить">×</button>
            </div>
          </div>
        `;
        mobileHistory.appendChild(card);
      });
    }

    function editTrade(index) {
      const trade = trades[index];
      
      document.getElementById("ticker").value = trade.ticker;
      document.getElementById("entry").value = trade.entry;
      document.getElementById("sl").value = trade.sl;
      document.getElementById("tp1_price").value = trade.tp1;
      document.getElementById("tp2_price").value = trade.tp2;
      document.getElementById("tp3_price").value = trade.tp3;
      document.getElementById("tp1_size").value = trade.tp1_size;
      document.getElementById("tp2_size").value = trade.tp2_size;
      document.getElementById("tp3_size").value = trade.tp3_size;
      document.getElementById("leverage").value = trade.leverage;
      
      calculate();
      alert("Сделка загружена в форму. Вы можете изменить параметры и пересчитать.");
    }

    function updateAnalytics() {
      if (trades.length === 0) {
        document.getElementById("totalTrades").textContent = "0";
        document.getElementById("avgRR").textContent = "—";
        document.getElementById("winningTrades").textContent = "0";
        document.getElementById("losingTrades").textContent = "0";
        document.getElementById("totalProfit").textContent = "0 руб";
        return;
      }

      const total = trades.length;
      const winning = trades.filter(t => parseFloat(t.profitMoney) > 0).length;
      const losing = trades.filter(t => parseFloat(t.profitMoney) < 0).length;
      const avgRR = trades.reduce((sum, t) => sum + parseFloat(t.rr), 0) / total;
      const totalProfitRub = trades.reduce((sum, t) => sum + parseFloat(t.profitMoney), 0);

      document.getElementById("totalTrades").textContent = total;
      document.getElementById("avgRR").textContent = avgRR.toFixed(2);
      document.getElementById("winningTrades").textContent = winning;
      document.getElementById("losingTrades").textContent = losing;
      document.getElementById("totalProfit").textContent = totalProfitRub.toFixed(2) + " руб";
    }

    function renderChart() {
      const ctx = document.getElementById('profitChart').getContext('2d');
      if (profitChart) profitChart.destroy();

      const labels = trades.map((_, i) => `Сделка ${i+1}`);
      let balance = parseFloat(document.getElementById("depositRub").value) || 100000;
      const data = [balance];

      trades.forEach(t => {
        balance += parseFloat(t.profitMoney);
        data.push(balance);
      });

      profitChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['Начало', ...labels],
          datasets: [{
            label: 'Баланс (руб)',
            data,
            borderColor: '#3498db',
            backgroundColor: 'rgba(52, 152, 219, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            tooltip: { mode: 'index', intersect: false }
          },
          scales: {
            y: { 
              beginAtZero: false,
              grid: { color: 'rgba(0,0,0,0.1)' }
            },
            x: {
              grid: { color: 'rgba(0,0,0,0.1)' }
            }
          }
        }
      });
    }

    // Вспомогательные функции
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function exportToCSV() {
      if (trades.length === 0) {
        alert("Нечего экспортировать.");
        return;
      }

      const headers = ["Дата", "Тикер", "Вход", "SL", "TP1", "TP2", "TP3", "Плечо", "R:R", "Результат (руб)", "Тип закрытия", "ID"];
      const rows = trades.map(t => [
        t.date, 
        t.ticker, 
        t.entry, 
        t.sl, 
        t.tp1, 
        t.tp2, 
        t.tp3,
        `x${t.leverage}`, 
        t.rr, 
        t.profitMoney,
        t.closedBy === 'sl' ? 'по стоп-лоссу' : 'по тейк-профиту',
        t.id
      ]);

      const csvContent = [headers.join(";"), ...rows.map(row => row.join(";"))].join("\n");
      const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", `trading_history_${new Date().toISOString().slice(0,10)}.csv`);
      link.click();
    }

    function importFromCSV() {
      document.getElementById('importFile').click();
    }

    function handleImport(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          let content = e.target.result;
          if (content.charCodeAt(0) === 0xFEFF) content = content.slice(1);
          
          const lines = content.split('\n');
          const importedTrades = [];
          
          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            const fields = line.split(';');
            if (fields.length >= 10) {
              const trade = {
                id: fields[11] || generateId(), // Используем ID из CSV если есть
                date: fields[0],
                ticker: fields[1],
                entry: parseFloat(fields[2]) || 0,
                sl: parseFloat(fields[3]) || 0,
                tp1: parseFloat(fields[4]) || 0,
                tp2: parseFloat(fields[5]) || 0,
                tp3: parseFloat(fields[6]) || 0,
                leverage: parseInt(fields[7].replace('x', '')) || 1,
                rr: fields[8] || '0',
                profitMoney: fields[9] || '0',
                closedBy: fields[10] && fields[10].includes('стоп') ? 'sl' : 'tp'
              };
              
              // Добавляем недостающие поля
              trade.profitUsd = (parseFloat(trade.profitMoney) / USD_RATE).toFixed(2);
              trade.moneyRiskRub = Math.abs(parseFloat(trade.profitMoney)) * 0.1;
              trade.potentialProfitRub = parseFloat(trade.profitMoney);
              trade.timestamp = new Date().toISOString();
              trade.tp1_size = 100;
              trade.tp2_size = 0;
              trade.tp3_size = 0;
              
              importedTrades.push(trade);
            }
          }
          
          if (importedTrades.length > 0) {
            const userChoice = confirm(`Найдено ${importedTrades.length} сделок. Добавить к существующим? (OK - добавить, Отмена - заменить все)`);
            
            if (userChoice) {
              // Добавляем к существующим
              trades = [...trades, ...importedTrades];
              await saveTradesToServer('add');
              alert(`Добавлено ${importedTrades.length} сделок к существующим!`);
            } else {
              // Заменяем все
              trades = importedTrades;
              await saveTradesToServer('replace');
              alert(`Все сделки заменены на ${importedTrades.length} импортированных!`);
            }
            
            localStorage.setItem('trades_backup', JSON.stringify(trades));
            updateHistory();
            updateAnalytics();
            renderChart();
          } else {
            alert("Не удалось найти сделки в файле.");
          }
        } catch (error) {
          alert("Ошибка при импорте файла: " + error.message);
          console.error(error);
        }
        
        event.target.value = '';
      };
      
      reader.readAsText(file, 'utf-8');
    }

    function clearHistory() {
      if (confirm("Очистить всю историю и график?")) {
        trades = [];
        localStorage.removeItem('trades_backup');
        updateHistory();
        updateAnalytics();
        renderChart();
      }
    }

    // Тема
    function enableDarkMode(dark) {
      const body = document.body;
      const icon = document.getElementById('themeIcon');

      if (dark) {
        body.classList.add('dark-mode');
        icon.innerHTML = `<path d="M12 17a5 5 0 1 0 0-10 5 5 0 0 0 0 10zm0-12a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0V6a1 1 0 0 1 1-1zm0 13a1 1 0 0 1-1 1v1a1 1 0 1 1 2 0v-1a1 1 0 0 1-1-1zm7.07-7.07a1 1 0 0 1 0 1.414l-.707.707a1 1 0 1 1-1.414-1.414l.707-.707a1 1 0 0 1 1.414 0zm-14.14 0a1 1 0 0 1 1.414 0l.707.707A1 1 0 1 1 5.64 12.22l-.707-.707a1 1 0 0 1 0-1.414zm7.07 7.07a1 1 0 0 1-1.414 0l-.707-.707a1 1 0 1 1 1.414-1.414l.707.707a1 1 0 0 1 0 1.414zm0-14.14a1 1 0 0 1 1.414 0l.707.707A1 1 0 1 1 18.36 5.78l-.707-.707a1 1 0 0 1-1.414 0z"/>`;
      } else {
        body.classList.remove('dark-mode');
        icon.innerHTML = `<path d="M12 3a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0V4a1 1 0 0 1 1-1zm7.07 3.07a1 1 0 0 1 0 1.414l-.707.707a1 1 0 1 1-1.414-1.414l.707-.707a1 1 0 0 1 1.414 0zm-14.14 0a1 1 0 0 1 1.414 0l.707.707A1 1 0 1 1 5.64 5.78l-.707-.707a1 1 0 0 1 0-1.414zM12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8zm-7 4a7 7 0 0 1 14 0 7 7 0 1 1-14 0z" />`;
      }
      localStorage.setItem('darkMode', dark);
    }

    document.getElementById('themeToggle').addEventListener('click', function() {
      const isCurrentlyDark = document.body.classList.contains('dark-mode');
      enableDarkMode(!isCurrentlyDark);
    });
  </script>
</body>
</html>

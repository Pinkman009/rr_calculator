<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Risk/Reward calculator</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>


    :root {
      --bg-body: #f7f9fc;
      --bg-card: #ffffff;
      --text: #333;
      --border: #b3d9ff;
      --header: #2c3e50;
      --btn-primary: #3498db;
      --btn-secondary: #95a5a6;
      --btn-danger: #e74c3c;
      --btn-success: #27ae60;
      --shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    body.dark-mode {
      --bg-body: #121212;
      --bg-card: #1e1e1e;
      --text: #e0e0e0;
      --border: #444;
      --header: #bbdefb;
      --btn-primary: #1976d2;
      --btn-secondary: #666;
      --btn-danger: #d32f2f;
      --btn-success: #2ecc71;
      --shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: var(--bg-body);
      color: var(--text);
      line-height: 1.6;
      transition: all 0.3s ease;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding-top: 80px;
    }

    h1, h2, h3, h4 {
      color: var(--header);
      margin: 20px 0 15px;
    }

    h1 {
      text-align: center;
      font-size: 2.2rem;
      margin-bottom: 30px;
    }

    h2 {
      font-size: 1.8rem;
      border-bottom: 2px solid var(--border);
      padding-bottom: 10px;
    }

    h3 {
      font-size: 1.4rem;
      margin-top: 25px;
    }

    /* –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
    .user-mini-card {
      position: fixed;
      top: 20px;
      left: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--bg-card);
      padding: 10px 15px;
      border-radius: 25px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      z-index: 1000;
      max-width: 250px;
      transition: all 0.3s ease;
    }

    .user-mini-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .user-mini-avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      border: 2px solid var(--border);
    }

    .user-mini-info {
      display: flex;
      flex-direction: column;
    }

    .user-mini-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--header);
    }

    .user-mini-id {
      font-size: 11px;
      color: #7f8c8d;
    }

    .user-mini-logout {
      background: transparent;
      border: none;
      color: #e74c3c;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      margin-left: 5px;
      transition: all 0.3s ease;
    }

    .user-mini-logout:hover {
      background: rgba(231, 76, 60, 0.1);
    }

    /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Telegram */
    .telegram-login-prompt {
      position: fixed;
      top: 20px;
      left: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--bg-card);
      padding: 10px 15px;
      border-radius: 25px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      z-index: 1000;
      max-width: 250px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .telegram-login-prompt:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .telegram-icon {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: #0088cc;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
    }

    .telegram-login-text {
      font-size: 14px;
      font-weight: 600;
      color: var(--header);
    }

    .telegram-login-subtext {
      font-size: 11px;
      color: #7f8c8d;
    }

    .sync-status-mini {
      position: fixed;
      top: 70px;
      left: 20px;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 10px;
      z-index: 1000;
      max-width: 250px;
    }

    .sync-success {
      color: #27ae60;
      background: rgba(39, 174, 96, 0.1);
    }

    .sync-error {
      color: #e74c3c;
      background: rgba(231, 76, 60, 0.1);
    }

    .sync-warning {
      color: #e67e22;
      background: rgba(230, 126, 34, 0.1);
    }

    .loading {
      opacity: 0.7;
    }

    /* –§–æ—Ä–º—ã */
    .form-section {
      background: var(--bg-card);
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 25px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
      position: relative;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 14px;
      color: var(--header);
    }

    input, select, button, textarea {
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      width: 100%;
      transition: all 0.3s ease;
      background: var(--bg-card);
      color: var(--text);
    }

    body.dark-mode input, 
    body.dark-mode select {
      background: #2d2d2d;
      border-color: #555;
      color: var(--text);
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--btn-primary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    button {
      background: var(--btn-primary);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      border-radius: 8px;
      margin: 5px 0;
      transition: all 0.3s ease;
      padding: 15px;
    }

    button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    button:active {
      transform: translateY(0);
    }

    button.secondary {
      background: var(--btn-secondary);
    }

    button.danger {
      background: var(--btn-danger);
    }

    button.success {
      background: var(--btn-success);
    }

    /* –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–µ–ø–æ–∑–∏—Ç–∞ */
    .save-deposit-btn {
      position: absolute;
      right: 5px;
      top: 35px;
      background: transparent;
      border: none;
      color: var(--btn-success);
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.3s ease;
      width: auto;
    }

    .save-deposit-btn:hover {
      background: rgba(39, 174, 96, 0.1);
      transform: scale(1.1);
    }

    .divider {
      margin: 25px 0;
      border: none;
      border-top: 2px solid var(--border);
    }

    /* –ï–¥–∏–Ω–æ–µ –ø–æ–ª–µ –¥–µ–ø–æ–∑–∏—Ç–∞ */
    .deposit-single {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }

    .deposit-amount {
      flex: 1;
    }

    .deposit-currency {
      width: 120px;
    }

    /* –ë–ª–æ–∫ —Ç–µ–∫—É—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞ */
    .balance-section {
      background: rgba(52, 152, 219, 0.05);
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      border: 1px solid var(--border);
    }

    .balance-display {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      font-weight: 600;
    }

    .balance-label {
      font-size: 12px;
      color: #7f8c8d;
      margin-top: 5px;
    }

    /* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã */
    .result, .history, .analytics {
      margin-top: 25px;
      padding: 25px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 15px;
      box-shadow: var(--shadow);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 14px;
      background: var(--bg-card);
    }

    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      background: var(--btn-primary);
      color: white;
      font-weight: 600;
    }

    .rr-good { color: #27ae60; font-weight: bold; }
    .rr-warn { color: #e67e22; font-weight: bold; }
    .profit-positive { color: #27ae60; font-weight: bold; }
    .profit-negative { color: #e74c3c; font-weight: bold; }

    .empty {
      text-align: center;
      color: #7f8c8d;
      font-style: italic;
      padding: 30px;
      font-size: 16px;
    }

    /* –ì—Ä–∞—Ñ–∏–∫ */
    .chart-container {
      margin-top: 25px;
      height: 400px;
      background: var(--bg-card);
      padding: 20px;
      border-radius: 15px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
    .buttons-row {
      display: flex;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .buttons-row button {
      flex: 1;
      min-width: 150px;
    }

    /* –¢–µ–º–∞ */
    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--btn-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: var(--shadow);
      z-index: 1000;
      transition: all 0.3s ease;
      border: none;
    }

    .theme-toggle:hover {
      transform: scale(1.1);
    }

    .theme-toggle svg {
      width: 24px;
      height: 24px;
      fill: white;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–µ—Ç—Ä–∏–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ */
    .safety-metric {
      background: rgba(52, 152, 219, 0.05);
    }

    .safety-metric td {
      font-weight: 600;
    }

    .warnings-section {
      margin-top: 20px;
      padding: 15px;
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 10px;
    }

    body.dark-mode .warnings-section {
      background: #382e0a;
      border-color: #857a2e;
    }

    .warning-item {
      padding: 8px 0;
      border-bottom: 1px solid rgba(0,0,0,0.1);
      font-size: 14px;
    }

    .warning-item:last-child {
      border-bottom: none;
    }

    .warning-high {
      color: #e74c3c;
      font-weight: bold;
    }

    .warning-medium {
      color: #e67e22;
      font-weight: bold;
    }

    .warning-low {
      color: #f39c12;
    }

    /* –ú–æ–±–∏–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫ */
    .mobile-trade-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 12px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .mobile-trade-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
    }

    .mobile-trade-ticker {
      font-weight: bold;
      font-size: 16px;
    }

    .mobile-trade-date {
      font-size: 12px;
      color: #7f8c8d;
    }

    .mobile-trade-main-info {
      margin-bottom: 10px;
    }

    .mobile-trade-entry-exit {
      font-size: 14px;
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .mobile-trade-stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .mobile-trade-rr, .mobile-trade-leverage {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .mobile-trade-rr span:first-child,
    .mobile-trade-leverage span:first-child {
      color: #7f8c8d;
      font-size: 12px;
    }

    .mobile-trade-close-type {
      margin-bottom: 10px;
    }

    .mobile-trade-close-type select {
      width: 100%;
      padding: 6px 8px;
      font-size: 13px;
      border-radius: 6px;
    }

    .mobile-trade-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 10px;
      border-top: 1px solid var(--border);
    }

    .mobile-trade-result {
      font-weight: bold;
      font-size: 16px;
      flex: 1;
    }

    .mobile-trade-buttons {
      display: flex;
      gap: 8px;
    }

    .delete-trade, .edit-trade {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 18px;
      padding: 6px;
      border-radius: 5px;
      transition: all 0.3s ease;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .delete-trade {
      color: #e74c3c;
    }

    .delete-trade:hover {
      background: rgba(231, 76, 60, 0.1);
    }

    .edit-trade {
      color: #3498db;
    }

    .edit-trade:hover {
      background: rgba(52, 152, 219, 0.1);
    }

    /* –ö–Ω–æ–ø–∫–∞ "–ü–æ–∫–∞–∑–∞—Ç—å –µ—â–µ" */
    .load-more-container {
      text-align: center;
      margin-top: 15px;
    }

    .load-more-btn {
      background: var(--btn-primary);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .load-more-btn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    .load-more-btn:disabled {
      background: var(--btn-secondary);
      cursor: not-allowed;
      transform: none;
    }

    /* –£–ª—É—á—à–µ–Ω–∏—è –¥–ª—è TP */
    .tp-section {
      background: rgba(52, 152, 219, 0.05);
      padding: 15px;
      border-radius: 10px;
      margin: 10px 0;
      position: relative;
    }

    .tp-input-group {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: end;
    }

    .tp-input-group input[type="number"] {
      margin-bottom: 0;
    }

    .add-tp-btn {
      background: var(--btn-success);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.3s ease;
      margin-top: 10px;
    }

    .add-tp-btn:hover {
      transform: scale(1.1);
    }

    .remove-tp-btn {
      background: transparent;
      border: none;
      color: #e74c3c;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      transition: all 0.3s ease;
      position: absolute;
      top: 10px;
      right: 10px;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .remove-tp-btn:hover {
      background: rgba(231, 76, 60, 0.1);
    }

    .percentage-label {
      font-size: 12px;
      color: #7f8c8d;
      text-align: center;
      margin-top: 5px;
    }

    /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫—É—Ä—Å–µ */
    .exchange-rate-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      font-size: 12px;
      color: #7f8c8d;
    }

    .refresh-rate {
      background: transparent;
      border: none;
      color: var(--btn-primary);
      cursor: pointer;
      padding: 2px 5px;
      border-radius: 3px;
      transition: all 0.3s ease;
    }

    .refresh-rate:hover {
      background: rgba(52, 152, 219, 0.1);
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 768px) {
      body {
        padding: 15px;
      }
      
      .container {
        padding: 0;
        padding-top: 70px;
      }
      
      h1 {
        font-size: 1.8rem;
        margin-bottom: 20px;
      }
      
      .grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .form-section, .result, .history, .analytics {
        padding: 20px;
      }
      
      .buttons-row {
        flex-direction: column;
      }
      
      .buttons-row button {
        min-width: auto;
      }
      
      .chart-container {
        height: 300px;
        padding: 15px;
      }
      
      .theme-toggle {
        top: 15px;
        right: 15px;
        width: 45px;
        height: 45px;
      }
      
      .desktop-history {
        display: none;
      }
      
      .mobile-history {
        display: block;
      }

      .user-mini-card,
      .telegram-login-prompt {
        top: 15px;
        left: 15px;
        max-width: 200px;
        padding: 8px 12px;
      }

      .user-mini-avatar,
      .telegram-icon {
        width: 30px;
        height: 30px;
      }

      .user-mini-name,
      .telegram-login-text {
        font-size: 13px;
      }

      .user-mini-id,
      .telegram-login-subtext {
        font-size: 10px;
      }

      .sync-status-mini {
        top: 60px;
        left: 15px;
        font-size: 10px;
      }

      .balance-display {
        flex-direction: column;
        gap: 5px;
      }

      .save-deposit-btn {
        top: 32px;
        right: 3px;
        padding: 6px;
      }

      .deposit-single {
        flex-direction: column;
        gap: 10px;
      }

      .deposit-currency {
        width: 100%;
      }

      .tp-input-group {
        grid-template-columns: 1fr;
        gap: 10px;
      }
    }

    @media (min-width: 769px) {
      .mobile-history {
        display: none;
      }
      
      .desktop-history {
        display: block;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      .form-section, .result, .history, .analytics {
        padding: 15px;
      }
      
      input, select, button {
        padding: 10px 12px;
        font-size: 16px;
      }
      
      .chart-container {
        height: 250px;
      }
      
      .mobile-trade-actions {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }
      
      .mobile-trade-buttons {
        width: 100%;
        justify-content: space-between;
      }

      .user-mini-card,
      .telegram-login-prompt {
        top: 10px;
        left: 10px;
        max-width: 180px;
        padding: 6px 10px;
      }

      .user-mini-avatar,
      .telegram-icon {
        width: 25px;
        height: 25px;
      }

      .user-mini-name,
      .telegram-login-text {
        font-size: 12px;
      }

      .user-mini-id {
        display: none;
      }

      .telegram-login-subtext {
        display: none;
      }

      .sync-status-mini {
        top: 50px;
        left: 10px;
      }

      .mobile-trade-card {
        padding: 12px;
        margin-bottom: 10px;
      }

      .mobile-trade-header {
        margin-bottom: 10px;
        padding-bottom: 10px;
      }

      .mobile-trade-ticker {
        font-size: 15px;
      }

      .mobile-trade-date {
        font-size: 11px;
      }

      .mobile-trade-entry-exit {
        font-size: 13px;
      }

      .mobile-trade-stats {
        font-size: 12px;
      }

      .mobile-trade-result {
        font-size: 15px;
      }

      .delete-trade, .edit-trade {
        font-size: 16px;
        width: 32px;
        height: 32px;
      }

      .save-deposit-btn {
        top: 30px;
        right: 2px;
        padding: 5px;
      }
    }

    /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.5s ease;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .spinning {
      animation: spin 1s linear infinite;
    }

    .tabs-container {
      margin-top: 25px;
    }

    .tabs-header {
      display: flex;
      border-bottom: 2px solid var(--border);
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 12px 20px;
      background: transparent;
      border: none;
      cursor: pointer;
      font-weight: 600;
      color: var(--text);
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
      margin-right: 5px;
    }

    .tab-btn.active {
      color: var(--btn-primary);
      border-bottom-color: var(--btn-primary);
      background: rgba(52, 152, 219, 0.1);
    }

    .tab-btn:hover {
      background: rgba(52, 152, 219, 0.05);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }

    .metric-card {
      background: var(--bg-card);
      padding: 20px;
      border-radius: 10px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      text-align: center;
    }

    .metric-value {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
    }

    .metric-good { color: #27ae60; }
    .metric-warning { color: #e67e22; }
    .metric-danger { color: #e74c3c; }

    .metric-label {
      font-size: 14px;
      color: #7f8c8d;
    }

    .analytics-section {
      margin-bottom: 30px;
    }

    .analytics-section h4 {
      margin-bottom: 15px;
      color: var(--header);
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
    }

    .analytics-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 14px;
    }

    .analytics-table th, 
    .analytics-table td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .analytics-table th {
      background: rgb(52, 152, 219);
      font-weight: 600;
    }

    .chart-small {
      height: 300px;
      margin-top: 15px;
    }

    .coins-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .coin-card {
      background: var(--bg-card);
      padding: 15px;
      border-radius: 8px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      text-align: center;
    }

    .coin-profit-positive {
      border-left: 4px solid #27ae60;
    }

    .coin-profit-negative {
      border-left: 4px solid #e74c3c;
    }

    .leverage-badge {
      display: inline-block;
      padding: 4px 8px;
      background: var(--btn-primary);
      color: white;
      border-radius: 12px;
      font-size: 12px;
      margin: 2px;
    }

    .time-analysis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 15px;
    }

    .time-card {
      background: var(--bg-card);
      padding: 15px;
      border-radius: 8px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      text-align: center;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ */
    @media (max-width: 768px) {
      .tabs-header {
        flex-direction: column;
      }

      .tab-btn {
        margin-right: 0;
        margin-bottom: 5px;
        text-align: left;
      }

      .metrics-grid {
        grid-template-columns: 1fr;
      }

      .coins-grid {
        grid-template-columns: 1fr;
      }

      .time-analysis {
        grid-template-columns: 1fr;
      }
    }

  </style>
</head>
<body>
  <!-- –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
  <div class="user-mini-card fade-in" id="userMiniCard" style="display: none;">
    <img id="userMiniAvatar" class="user-mini-avatar" src="" alt="–ê–≤–∞—Ç–∞—Ä">
    <div class="user-mini-info">
      <div class="user-mini-name" id="userMiniName"></div>
      <div class="user-mini-id" id="userMiniId"></div>
    </div>
    <button class="user-mini-logout" onclick="logout()" title="–í—ã–π—Ç–∏">üö™</button>
  </div>

  <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Telegram -->
  <div class="telegram-login-prompt fade-in" id="telegramLoginPrompt" style="display: none;" onclick="openTelegram()">
    <div class="telegram-icon">‚úàÔ∏è</div>
    <div class="user-mini-info">
      <div class="telegram-login-text">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram</div>
      <div class="telegram-login-subtext">–¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–¥–µ–ª–æ–∫</div>
    </div>
  </div>

  <!-- –°—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ -->
  <div class="sync-status-mini" id="syncStatusMini"></div>

  <div class="theme-toggle" id="themeToggle" role="button" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
    <svg id="themeIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M12 3a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0V4a1 1 0 0 1 1-1zm7.07 3.07a1 1 0 0 1 0 1.414l-.707.707a1 1 0 1 1-1.414-1.414l.707-.707a1 1 0 0 1 1.414 0zm-14.14 0a1 1 0 0 1 1.414 0l.707.707A1 1 0 1 1 5.64 5.78l-.707-.707a1 1 0 0 1 0-1.414zM12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8zm-7 4a7 7 0 0 1 14 0 7 7 0 1 1-14 0z" />
    </svg>
  </div>

  <div class="container">
    <h1>üéØ Risk/Reward calculator</h1>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ -->
    <div class="form-section fade-in">
      <!-- –ï–¥–∏–Ω–æ–µ –ø–æ–ª–µ –¥–µ–ø–æ–∑–∏—Ç–∞ -->
      <div class="form-group">
        <label for="depositAmount">–ù–∞—á–∞–ª—å–Ω—ã–π –¥–µ–ø–æ–∑–∏—Ç:</label>
        <div class="deposit-single">
          <div class="deposit-amount">
            <input type="number" id="depositAmount" step="any" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 100000" value="100000"/>
          </div>
          <div class="deposit-currency">
            <select id="depositCurrency">
              <option value="RUB">RUB</option>
              <option value="USD">USD</option>
            </select>
          </div>
          <button class="save-deposit-btn" onclick="saveDeposit()" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–µ–ø–æ–∑–∏—Ç">üíæ</button>
        </div>
      </div>

      <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫—É—Ä—Å–µ -->
      <div class="exchange-rate-info">
        <span id="exchangeRateInfo">–ö—É—Ä—Å USD: –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</span>
        <button class="refresh-rate" onclick="fetchExchangeRate()" title="–û–±–Ω–æ–≤–∏—Ç—å –∫—É—Ä—Å">üîÑ</button>
      </div>

      <!-- –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å -->
      <div class="balance-section">
        <label style="font-weight: bold; color: var(--btn-primary);">üí∞ –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å:</label>
        <div class="balance-display">
          <span id="currentBalanceRub">100000.00 —Ä—É–±</span>
          <span id="currentBalanceUsd">1050.00 USD</span>
        </div>
        <div class="balance-label">
          (–ù–∞—á–∞–ª—å–Ω—ã–π –¥–µ–ø–æ–∑–∏—Ç + —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–æ—Ä–≥–æ–≤)
        </div>
      </div>

      <div class="form-group">
        <label for="riskPercent">–†–∏—Å–∫ –Ω–∞ —Å–¥–µ–ª–∫—É (%):</label>
        <input type="number" id="riskPercent" step="0.1" value="1.5" placeholder="1‚Äì2%" />
      </div>

      <hr class="divider">

      <div class="form-group">
        <label for="ticker">–¢–∏–∫–µ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, BTC/USDT):</label>
        <input type="text" id="ticker" placeholder="BTC/USDT" value="VELO/USDT"/>
      </div>
      
      <div class="grid">
        <div class="form-group">
          <label for="entry">–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞:</label>
          <input type="number" id="entry" step="any" placeholder="68000" value="0.013393"/>
        </div>
        <div class="form-group">
          <label for="sl">–°—Ç–æ–ø-–ª–æ—Å—Å (SL):</label>
          <input type="number" id="sl" step="any" placeholder="70000" value="0.009876"/>
        </div>
      </div>

      <h3>üéØ –¢–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç—ã (TP)</h3>
      
      <div id="tp-container">
        <!-- TP –ø–æ–ª—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </div>
      
      <button type="button" class="add-tp-btn" onclick="addTpField()">+</button>

      <div class="form-group">
        <label for="leverage">–ü–ª–µ—á–æ:</label>
        <select id="leverage">
          <option value="1">x1</option>
          <option value="2">x2</option>
          <option value="3">x3</option>
          <option value="4">x4</option>
          <option value="5">x5</option>
          <option value="10">x10</option>
          <option value="20">x20</option>
          <option value="50">x50</option>
          <option value="100" selected>x100</option>
        </select>
      </div>

      <button onclick="calculate()">üìä –†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞ -->
    <div class="result fade-in" id="result" style="display:none;">
      <h3>üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á—ë—Ç–∞</h3>
      <table>
        <tr><td>–ú–æ–Ω–µ—Ç–∞:</td><td><span id="resultTicker"></span></td></tr>
        <tr><td>–†–∏—Å–∫ –≤ –¥–µ–Ω—å–≥–∞—Ö:</td><td><span id="moneyRisk"></span> —Ä—É–± / <span id="moneyRiskUsd"></span> USD</td></tr>
        <tr><td>–†–∏—Å–∫ (%) –æ—Ç —Ü–µ–Ω—ã:</td><td><span id="riskPercentVal"></span>%</td></tr>
        <tr><td>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–∏–±—ã–ª—å (%):</td><td><span id="profitPercentVal"></span>%</td></tr>
        <tr><td>R:R (Risk/Reward)</td><td><span id="rrValue"></span></td></tr>
        <tr><td>–ü–ª–µ—á–æ</td><td>x<span id="leverageUsed"></span></td></tr>
        <tr><td>–†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏:</td><td><span id="positionSize"></span> USDT</td></tr>
        <tr><td>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–∏–±—ã–ª—å:</td><td><span id="profitMoney"></span> —Ä—É–± (<span id="profitUsd"></span> USD)</td></tr>
        <tr><td>–ü—Ä–∏–±—ã–ª—å (% –æ—Ç –±–∞–ª–∞–Ω—Å–∞):</td><td><span id="profitPercentDeposit"></span>%</td></tr>
        
        <!-- –ú–ï–¢–†–ò–ö–ò –î–õ–Ø –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò -->
        <tr class="safety-metric">
          <td>üí∞ –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ (% –æ—Ç –±–∞–ª–∞–Ω—Å–∞):</td>
          <td><span id="positionSizePercent"></span>%</td>
        </tr>
        <tr class="safety-metric">
          <td>‚ö° –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∞—Ä–∂–∏ (%):</td>
          <td><span id="marginUsage"></span>%</td>
        </tr>
        <tr class="safety-metric">
          <td>üõ°Ô∏è –°–≤–æ–±–æ–¥–Ω–∞—è –º–∞—Ä–∂–∞ –ø–æ—Å–ª–µ —Å–¥–µ–ª–∫–∏:</td>
          <td><span id="freeMarginAfter"></span> —Ä—É–±</td>
        </tr>
        <tr class="safety-metric">
          <td>üìä –ú–∞–∫—Å. –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–∞:</td>
          <td><span id="maxDepositUsage"></span>%</td>
        </tr>
        <tr class="safety-metric">
          <td>üéØ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –æ–±—ä–µ–º –ø–æ–∑–∏—Ü–∏–∏:</td>
          <td><span id="recommendedPositionSize"></span> USDT</td>
        </tr>
      </table>

      <!-- –ë–ª–æ–∫ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π -->
      <div class="warnings-section" id="warningsSection" style="display: none;">
        <h4>‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</h4>
        <div id="warningsList"></div>
      </div>
      
      <div class="buttons-row">
        <button class="success" onclick="saveTrade()">üìå –ó–∞–ø–∏—Å–∞—Ç—å —Å–¥–µ–ª–∫—É</button>
      </div>
    </div>

    <!-- –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫ -->
    <div class="history fade-in">
      <h2>üìã –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫</h2>
      <div class="buttons-row">
        <button class="secondary" onclick="exportToCSV()">üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</button>
        <button class="success" onclick="importFromCSV()" id="importBtn">üì• –ò–º–ø–æ—Ä—Ç –∏–∑ CSV</button>
        <button class="danger" onclick="clearHistory()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
      </div>
      
      <!-- –î–µ—Å–∫—Ç–æ–ø –≤–µ—Ä—Å–∏—è -->
      <div class="desktop-history">
        <table id="historyTable">
          <thead>
            <tr>
              <th>–î–∞—Ç–∞</th>
              <th>–ú–æ–Ω–µ—Ç–∞</th>
              <th>–í—Ö–æ–¥ ‚Üí –í—ã—Ö–æ–¥</th>
              <th>R:R</th>
              <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
              <th>–¢–∏–ø –∑–∞–∫—Ä—ã—Ç–∏—è</th>
              <th>–ü–ª–µ—á–æ</th>
              <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody id="historyBody">
            <tr><td colspan="8" class="empty">–ü–æ–∫–∞ –Ω–µ—Ç —Å–¥–µ–ª–æ–∫</td></tr>
          </tbody>
        </table>
      </div>
      
      <!-- –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è -->
      <div class="mobile-history" id="mobileHistory">
        <div class="empty">–ü–æ–∫–∞ –Ω–µ—Ç —Å–¥–µ–ª–æ–∫</div>
      </div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
   <!-- –ì—Ä–∞—Ñ–∏–∫ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
    <div class="chart-container fade-in">
      <canvas id="profitChart"></canvas>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∏ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ -->
    <div class="tabs-container fade-in">
      <div class="tabs-header">
        <button class="tab-btn active" onclick="openTab('basic-analytics')">üìä –ë–∞–∑–æ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
        <button class="tab-btn" onclick="openTab('advanced-analytics')">üìà –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
      </div>

      <!-- –ë–∞–∑–æ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
      <div id="basic-analytics" class="tab-content active">
        <div class="analytics">
          <h3>üìä –ë–∞–∑–æ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —Å–¥–µ–ª–∫–∞–º</h3>
          <table id="analyticsTable">
            <tr><td>–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫:</td><td id="totalTrades">0</td></tr>
            <tr><td>–í—ã–∏–≥—Ä—ã—à–Ω—ã—Ö:</td><td id="winningTrades">0</td></tr>
            <tr><td>–ü—Ä–æ–∏–≥—Ä—ã—à–Ω—ã—Ö:</td><td id="losingTrades">0</td></tr>
            <tr><td>–°—Ä–µ–¥–Ω–∏–π R:R:</td><td id="avgRR">‚Äî</td></tr>
            <tr><td>–û–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</td><td id="totalProfit">0 —Ä—É–±</td></tr>
          </table>
        </div>
      </div>

      <!-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
      <div id="advanced-analytics" class="tab-content">
        <div class="analytics">
          <h3>üìà –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h3>

          <!-- –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
          <div class="metrics-grid">
            <div class="metric-card">
              <div class="metric-label">Win Rate</div>
              <div class="metric-value" id="winRate">0%</div>
              <div class="metric-label">–ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∏–±—ã–ª—å–Ω—ã—Ö —Å–¥–µ–ª–æ–∫</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">–°—Ä–µ–¥–Ω–∏–π –ø—Ä–æ—Ñ–∏—Ç</div>
              <div class="metric-value metric-good" id="avgWin">0 —Ä—É–±</div>
              <div class="metric-label">–ù–∞ –≤—ã–∏–≥—Ä—ã—à–Ω—É—é —Å–¥–µ–ª–∫—É</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">–°—Ä–µ–¥–Ω–∏–π —É–±—ã—Ç–æ–∫</div>
              <div class="metric-value metric-danger" id="avgLoss">0 —Ä—É–±</div>
              <div class="metric-label">–ù–∞ –ø—Ä–æ–∏–≥—Ä—ã—à–Ω—É—é —Å–¥–µ–ª–∫—É</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Profit Factor</div>
              <div class="metric-value" id="profitFactor">0</div>
              <div class="metric-label">–ü—Ä–∏–±—ã–ª—å / –£–±—ã—Ç–æ–∫</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Expectancy</div>
              <div class="metric-value" id="expectancy">0</div>
              <div class="metric-label">–û–∂–∏–¥–∞–µ–º–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">–ú–∞–∫—Å. —Å–µ—Ä–∏—è —É–±—ã—Ç–∫–æ–≤</div>
              <div class="metric-value metric-danger" id="maxLossStreak">0</div>
              <div class="metric-label">–ü–æ–¥—Ä—è–¥ —É–±—ã—Ç–æ—á–Ω—ã—Ö —Å–¥–µ–ª–æ–∫</div>
            </div>
          </div>

          <!-- –ê–Ω–∞–ª–∏–∑ –ø–æ R:R -->
          <div class="analytics-section">
            <h4>üéØ –ê–Ω–∞–ª–∏–∑ –ø–æ Risk/Reward</h4>
            <table class="analytics-table">
              <thead>
                <tr>
                  <th>–î–∏–∞–ø–∞–∑–æ–Ω R:R</th>
                  <th>–ö–æ–ª-–≤–æ —Å–¥–µ–ª–æ–∫</th>
                  <th>Win Rate</th>
                  <th>–°—Ä–µ–¥–Ω—è—è –ø—Ä–∏–±—ã–ª—å</th>
                </tr>
              </thead>
              <tbody id="rrAnalysisBody">
                <tr><td colspan="4" class="empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</td></tr>
              </tbody>
            </table>
          </div>

          <!-- –ê–Ω–∞–ª–∏–∑ –ø–æ –º–æ–Ω–µ—Ç–∞–º -->
          <div class="analytics-section">
            <h4>üí∞ –ê–Ω–∞–ª–∏–∑ –ø–æ –º–æ–Ω–µ—Ç–∞–º</h4>
            <div class="coins-grid" id="coinsAnalysis">
              <div class="empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</div>
            </div>
          </div>

          <!-- –ê–Ω–∞–ª–∏–∑ –ø–æ –ø–ª–µ—á—É -->
          <div class="analytics-section">
            <h4>‚ö° –ê–Ω–∞–ª–∏–∑ –ø–æ –ø–ª–µ—á—É</h4>
            <table class="analytics-table">
              <thead>
                <tr>
                  <th>–ü–ª–µ—á–æ</th>
                  <th>–ö–æ–ª-–≤–æ —Å–¥–µ–ª–æ–∫</th>
                  <th>Win Rate</th>
                  <th>–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å</th>
                </tr>
              </thead>
              <tbody id="leverageAnalysisBody">
                <tr><td colspan="4" class="empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</td></tr>
              </tbody>
            </table>
          </div>

          <!-- –ê–Ω–∞–ª–∏–∑ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ -->
          <div class="analytics-section">
            <h4>üïí –ê–Ω–∞–ª–∏–∑ –ø–æ –≤—Ä–µ–º–µ–Ω–∏</h4>
            <div class="time-analysis">
              <div class="time-card">
                <div class="metric-label">–õ—É—á—à–∏–π –¥–µ–Ω—å</div>
                <div class="metric-value" id="bestDay">‚Äî</div>
                <div class="metric-label">–¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏</div>
              </div>
              <div class="time-card">
                <div class="metric-label">–•—É–¥—à–∏–π –¥–µ–Ω—å</div>
                <div class="metric-value" id="worstDay">‚Äî</div>
                <div class="metric-label">–¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏</div>
              </div>
            </div>
          </div>

          <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ -->
          <div class="analytics-section">
            <h4>üìà –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è</h4>
            <div class="chart-container chart-small">
              <canvas id="distributionChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <input type="file" id="importFile" accept=".csv" style="display: none;">

  <script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    const SERVER_URL = 'https://trading-app-backend-cj71.onrender.com/api';
    const BOT_USERNAME = 'rrcalc_bot';
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let trades = [];
    let profitChart = null;
    let currentCalculation = null;
    let currentUser = null;
    let isOnline = false;
    let isTelegramWebApp = false;
    let USD_RATE = 95; // –ë—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    let distributionChart = null;
    
    // –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏
    let mobileVisibleCount = 5;
    const MOBILE_LOAD_MORE_COUNT = 10;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫
    function openTab(tabName) {
      // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
      const tabContents = document.getElementsByClassName('tab-content');
      for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove('active');
      }
   // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
      const tabButtons = document.getElementsByClassName('tab-btn');
      for (let i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove('active');
      }

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
      document.getElementById(tabName).classList.add('active');
      event.currentTarget.classList.add('active');

      // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–µ
      if (tabName === 'advanced-analytics') {
        updateExtendedAnalytics();
      }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    function updateExtendedAnalytics() {
      if (trades.length === 0) {
        return;
      }

      // –†–∞—Å—á–µ—Ç –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫
      const totalTrades = trades.length;
      const winningTrades = trades.filter(t => parseFloat(t.profitMoney) > 0);
      const losingTrades = trades.filter(t => parseFloat(t.profitMoney) < 0);
      
      const winRate = (winningTrades.length / totalTrades * 100).toFixed(1);
      const avgWin = winningTrades.length > 0 ? 
        winningTrades.reduce((sum, t) => sum + parseFloat(t.profitMoney), 0) / winningTrades.length : 0;
      const avgLoss = losingTrades.length > 0 ? 
        losingTrades.reduce((sum, t) => sum + parseFloat(t.profitMoney), 0) / losingTrades.length : 0;
      
      const totalProfit = winningTrades.reduce((sum, t) => sum + parseFloat(t.profitMoney), 0);
      const totalLoss = Math.abs(losingTrades.reduce((sum, t) => sum + parseFloat(t.profitMoney), 0));
      
      const profitFactor = totalLoss > 0 ? (totalProfit / totalLoss).toFixed(2) : '‚àû';
      const expectancy = ((winRate / 100) * avgWin - ((100 - winRate) / 100) * Math.abs(avgLoss)).toFixed(2);

      // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–µ—Ä–∏—è —É–±—ã—Ç–∫–æ–≤
      let currentStreak = 0;
      let maxLossStreak = 0;
      
      trades.forEach(trade => {
        if (parseFloat(trade.profitMoney) < 0) {
          currentStreak++;
          maxLossStreak = Math.max(maxLossStreak, currentStreak);
        } else {
          currentStreak = 0;
        }
      });

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ DOM
      document.getElementById('winRate').textContent = winRate + '%';
      document.getElementById('avgWin').textContent = avgWin.toFixed(2) + ' —Ä—É–±';
      document.getElementById('avgLoss').textContent = avgLoss.toFixed(2) + ' —Ä—É–±';
      document.getElementById('profitFactor').textContent = profitFactor;
      document.getElementById('expectancy').textContent = expectancy;
      document.getElementById('maxLossStreak').textContent = maxLossStreak;

      // –ê–Ω–∞–ª–∏–∑ –ø–æ R:R
      updateRRAnalysis();

      // –ê–Ω–∞–ª–∏–∑ –ø–æ –º–æ–Ω–µ—Ç–∞–º
      updateCoinsAnalysis();

      // –ê–Ω–∞–ª–∏–∑ –ø–æ –ø–ª–µ—á—É
      updateLeverageAnalysis();

      // –ê–Ω–∞–ª–∏–∑ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
      updateTimeAnalysis();

      // –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
      renderDistributionChart();
    }

    // –ê–Ω–∞–ª–∏–∑ –ø–æ R:R
    function updateRRAnalysis() {
      const rrRanges = [
        { min: 0, max: 1, label: 'R:R < 1' },
        { min: 1, max: 2, label: 'R:R 1-2' },
        { min: 2, max: 3, label: 'R:R 2-3' },
        { min: 3, max: Infinity, label: 'R:R > 3' }
      ];

      const analysis = rrRanges.map(range => {
        const rangeTrades = trades.filter(t => {
          const rr = parseFloat(t.rr);
          return rr >= range.min && rr < range.max;
        });

        const winning = rangeTrades.filter(t => parseFloat(t.profitMoney) > 0);
        const winRate = rangeTrades.length > 0 ? (winning.length / rangeTrades.length * 100).toFixed(1) : 0;
        const avgProfit = rangeTrades.length > 0 ? 
          rangeTrades.reduce((sum, t) => sum + parseFloat(t.profitMoney), 0) / rangeTrades.length : 0;

        return {
          label: range.label,
          count: rangeTrades.length,
          winRate: winRate,
          avgProfit: avgProfit
        };
      });

      const tbody = document.getElementById('rrAnalysisBody');
      tbody.innerHTML = '';

      analysis.forEach(item => {
        if (item.count > 0) {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${item.label}</td>
            <td>${item.count}</td>
            <td>${item.winRate}%</td>
            <td class="${item.avgProfit >= 0 ? 'profit-positive' : 'profit-negative'}">${item.avgProfit.toFixed(2)} —Ä—É–±</td>
          `;
          tbody.appendChild(row);
        }
      });

      if (tbody.children.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</td></tr>';
      }
    }

    // –ê–Ω–∞–ª–∏–∑ –ø–æ –º–æ–Ω–µ—Ç–∞–º
    function updateCoinsAnalysis() {
      const coins = {};
      
      trades.forEach(trade => {
        if (!coins[trade.ticker]) {
          coins[trade.ticker] = {
            count: 0,
            profit: 0,
            winning: 0
          };
        }
        
        coins[trade.ticker].count++;
        coins[trade.ticker].profit += parseFloat(trade.profitMoney);
        if (parseFloat(trade.profitMoney) > 0) {
          coins[trade.ticker].winning++;
        }
      });

      const coinsGrid = document.getElementById('coinsAnalysis');
      coinsGrid.innerHTML = '';

      Object.entries(coins).forEach(([ticker, data]) => {
        const winRate = (data.winning / data.count * 100).toFixed(1);
        const card = document.createElement('div');
        card.className = `coin-card ${data.profit >= 0 ? 'coin-profit-positive' : 'coin-profit-negative'}`;
        card.innerHTML = `
          <div style="font-weight: bold; margin-bottom: 8px;">${ticker}</div>
          <div>–°–¥–µ–ª–æ–∫: ${data.count}</div>
          <div>Win Rate: ${winRate}%</div>
          <div class="${data.profit >= 0 ? 'profit-positive' : 'profit-negative'}" style="font-weight: bold; margin-top: 5px;">
            ${data.profit >= 0 ? '+' : ''}${data.profit.toFixed(2)} —Ä—É–±
          </div>
        `;
        coinsGrid.appendChild(card);
      });

      if (coinsGrid.children.length === 0) {
        coinsGrid.innerHTML = '<div class="empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</div>';
      }
    }

    // –ê–Ω–∞–ª–∏–∑ –ø–æ –ø–ª–µ—á—É
    function updateLeverageAnalysis() {
      const leverageMap = {};
      
      trades.forEach(trade => {
        const leverage = trade.leverage;
        if (!leverageMap[leverage]) {
          leverageMap[leverage] = {
            count: 0,
            profit: 0,
            winning: 0
          };
        }
        
        leverageMap[leverage].count++;
        leverageMap[leverage].profit += parseFloat(trade.profitMoney);
        if (parseFloat(trade.profitMoney) > 0) {
          leverageMap[leverage].winning++;
        }
      });

      const tbody = document.getElementById('leverageAnalysisBody');
      tbody.innerHTML = '';

      Object.entries(leverageMap).forEach(([leverage, data]) => {
        const winRate = (data.winning / data.count * 100).toFixed(1);
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>x${leverage}</td>
          <td>${data.count}</td>
          <td>${winRate}%</td>
          <td class="${data.profit >= 0 ? 'profit-positive' : 'profit-negative'}">${data.profit.toFixed(2)} —Ä—É–±</td>
        `;
        tbody.appendChild(row);
      });

      if (tbody.children.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</td></tr>';
      }
    }

    // –ê–Ω–∞–ª–∏–∑ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
    function updateTimeAnalysis() {
      const days = ['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞'];
      const dayProfits = {};
      
      days.forEach(day => dayProfits[day] = 0);
      
      trades.forEach(trade => {
        try {
          const date = new Date(trade.timestamp || trade.date);
          const dayName = days[date.getDay()];
          dayProfits[dayName] += parseFloat(trade.profitMoney);
        } catch (e) {
          console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –¥–∞—Ç—É:', trade.date);
        }
      });

      let bestDay = { name: '', profit: -Infinity };
      let worstDay = { name: '', profit: Infinity };

      Object.entries(dayProfits).forEach(([day, profit]) => {
        if (profit > bestDay.profit) {
          bestDay = { name: day, profit };
        }
        if (profit < worstDay.profit) {
          worstDay = { name: day, profit };
        }
      });

      document.getElementById('bestDay').textContent = bestDay.name;
      document.getElementById('worstDay').textContent = worstDay.name;
    }

    // –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏–±—ã–ª–µ–π/—É–±—ã—Ç–∫–æ–≤
    function renderDistributionChart() {
      const ctx = document.getElementById('distributionChart').getContext('2d');
      if (distributionChart) distributionChart.destroy();

      const profits = trades.map(t => parseFloat(t.profitMoney));
      
      // –°–æ–∑–¥–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω—ã –¥–ª—è –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã
      const minProfit = Math.min(...profits);
      const maxProfit = Math.max(...profits);
      const range = maxProfit - minProfit;
      const binCount = 10;
      const binSize = range / binCount;
      
      const bins = Array(binCount).fill(0);
      const labels = [];
      
      for (let i = 0; i < binCount; i++) {
        const start = minProfit + i * binSize;
        const end = start + binSize;
        labels.push(`${start.toFixed(0)} - ${end.toFixed(0)}`);
        
        bins[i] = profits.filter(p => p >= start && p < end).length;
      }

      distributionChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–¥–µ–ª–æ–∫',
            data: bins,
            backgroundColor: bins.map(count => 
              count > 0 ? 'rgba(52, 152, 219, 0.7)' : 'rgba(231, 76, 60, 0.7)'
            ),
            borderColor: bins.map(count => 
              count > 0 ? 'rgba(52, 152, 219, 1)' : 'rgba(231, 76, 60, 1)'
            ),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: {
              display: true,
              text: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏–±—ã–ª–µ–π/—É–±—ã—Ç–∫–æ–≤'
            }
          },
          scales: {
            y: { 
              beginAtZero: true,
              title: { display: true, text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–¥–µ–ª–æ–∫' }
            },
            x: { 
              title: { display: true, text: '–î–∏–∞–ø–∞–∑–æ–Ω –ø—Ä–∏–±—ã–ª–∏ (—Ä—É–±)' }
            }
          }
        }
      });
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–∑–æ–≤—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É, —á—Ç–æ–±—ã –æ–Ω–∞ —Ç–∞–∫–∂–µ –≤—ã–∑—ã–≤–∞–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    const originalUpdateAnalytics = updateAnalytics;
    updateAnalytics = function() {
      originalUpdateAnalytics();
      
      // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –≤–∫–ª–∞–¥–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–µ
      if (document.getElementById('advanced-analytics').classList.contains('active')) {
        updateExtendedAnalytics();
      }
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', function() {
      // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ...
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∫–ª–∞–¥–∫–∏
      openTab('basic-analytics');
    });
 


    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    document.addEventListener('DOMContentLoaded', function() {
      initApp();
    });

    async function initApp() {
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –∫—É—Ä—Å –∏ –¥–µ–ø–æ–∑–∏—Ç
      loadSavedData();
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º TP –ø–æ–ª—è
      initTpFields();
      
      // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∫—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞
      await fetchExchangeRate();
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—Ä—ã—Ç–æ –ª–∏ –≤ Telegram Web App
      checkTelegramWebApp();
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–¥–µ–ª–∫–∏ –∏–∑ localStorage
      loadTradesFromLocalStorage();
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
      const savedUser = localStorage.getItem('telegramUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showUserMiniInfo(currentUser);
      } else {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –¥–ª—è –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Telegram
        document.getElementById('telegramLoginPrompt').style.display = 'flex';
      }

      updateCurrentBalance();
      updateHistory();
      updateAnalytics();
      renderChart();

      const isDark = localStorage.getItem('darkMode') === 'true';
      enableDarkMode(isDark);

      document.getElementById('importFile').addEventListener('change', handleImport);
      
      // –°–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è –¥–µ–ø–æ–∑–∏—Ç–∞
      setupDepositListeners();
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TP –ø–æ–ª–µ–π
    function initTpFields() {
      const tpContainer = document.getElementById('tp-container');
      tpContainer.innerHTML = '';
      addTpField(); // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ TP –ø–æ–ª—è
    function addTpField() {
      const tpContainer = document.getElementById('tp-container');
      const tpId = generateId();
      
      const tpSection = document.createElement('div');
      tpSection.className = 'tp-section';
      tpSection.innerHTML = `
        <button class="remove-tp-btn" onclick="removeTpField('${tpId}')" ${tpContainer.children.length === 0 ? 'style="display: none;"' : ''}>√ó</button>
        <div class="tp-input-group">
          <div class="form-group">
            <label>TP –¶–µ–Ω–∞:</label>
            <input type="number" class="tp-price" step="any" placeholder="–¶–µ–Ω–∞" value="0.020913"/>
          </div>
          <div class="form-group">
            <label>% –æ–±—ä–µ–º–∞:</label>
            <input type="number" class="tp-size" value="100" min="0" max="100"/>
          </div>
        </div>
      `;
      tpSection.id = `tp-${tpId}`;
      tpContainer.appendChild(tpSection);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
      updateRemoveTpButtons();
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ TP –ø–æ–ª—è
    function removeTpField(tpId) {
      const tpElement = document.getElementById(`tp-${tpId}`);
      if (tpElement) {
        tpElement.remove();
        updateRemoveTpButtons();
      }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è TP
    function updateRemoveTpButtons() {
      const tpContainer = document.getElementById('tp-container');
      const removeButtons = tpContainer.querySelectorAll('.remove-tp-btn');
      
      // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è, –µ—Å–ª–∏ –æ—Å—Ç–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ –ø–æ–ª–µ
      if (removeButtons.length === 1) {
        removeButtons[0].style.display = 'none';
      } else {
        removeButtons.forEach(btn => btn.style.display = 'block');
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    function loadSavedData() {
      const savedDepositAmount = localStorage.getItem('depositAmount');
      const savedDepositCurrency = localStorage.getItem('depositCurrency');
      const savedUsdRate = localStorage.getItem('usdRate');
      
      if (savedDepositAmount) {
        document.getElementById('depositAmount').value = savedDepositAmount;
      }
      
      if (savedDepositCurrency) {
        document.getElementById('depositCurrency').value = savedDepositCurrency;
      }
      
      if (savedUsdRate) {
        USD_RATE = parseFloat(savedUsdRate);
      }
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π –¥–ª—è –¥–µ–ø–æ–∑–∏—Ç–∞
    function setupDepositListeners() {
      const depositAmount = document.getElementById('depositAmount');
      const depositCurrency = document.getElementById('depositCurrency');
      
      depositAmount.addEventListener('input', function() {
        updateCurrentBalance();
        renderChart();
      });
      
      depositCurrency.addEventListener('change', function() {
        updateCurrentBalance();
        renderChart();
      });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–µ–ø–æ–∑–∏—Ç–∞
    function saveDeposit() {
      const depositAmount = document.getElementById('depositAmount').value;
      const depositCurrency = document.getElementById('depositCurrency').value;
      
      localStorage.setItem('depositAmount', depositAmount);
      localStorage.setItem('depositCurrency', depositCurrency);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      showNotification('–î–µ–ø–æ–∑–∏—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!', 'success');
      
      updateCurrentBalance();
      renderChart();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—É—Ä—Å–∞ –¥–æ–ª–ª–∞—Ä–∞
    async function fetchExchangeRate() {
      const refreshBtn = document.querySelector('.refresh-rate');
      const rateInfo = document.getElementById('exchangeRateInfo');
      
      try {
        refreshBtn.classList.add('spinning');
        rateInfo.textContent = '–ö—É—Ä—Å USD: –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...';
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º API –¶–µ–Ω—Ç—Ä–æ–±–∞–Ω–∫–∞ –†–æ—Å—Å–∏–∏
        const response = await fetch('https://www.cbr-xml-daily.ru/daily_json.js');
        
        if (!response.ok) {
          throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–∞');
        }
        
        const data = await response.json();
        const usdRate = data.Valute.USD.Value;
        
        USD_RATE = usdRate;
        localStorage.setItem('usdRate', usdRate.toString());
        
        rateInfo.textContent = `–ö—É—Ä—Å USD: ${usdRate.toFixed(2)} —Ä—É–±`;
        
        showNotification('–ö—É—Ä—Å –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫—É—Ä—Å–∞:', error);
        rateInfo.textContent = '–ö—É—Ä—Å USD: –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–∞', 'error');
      } finally {
        refreshBtn.classList.remove('spinning');
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showNotification(message, type = 'info') {
      // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db'};
        color: white;
        padding: 12px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 1001;
        text-align: center;
        max-width: 90%;
        font-weight: 600;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
        }
      }, 3000);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è Telegram
    function openTelegram() {
      window.open(`https://t.me/${BOT_USERNAME}`, '_blank');
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram Web App
    function checkTelegramWebApp() {
      if (window.Telegram && window.Telegram.WebApp) {
        isTelegramWebApp = true;
        const tg = window.Telegram.WebApp;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram Web App
        tg.ready();
        tg.expand();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const user = tg.initDataUnsafe?.user;
        if (user) {
          const telegramUser = {
            id: user.id.toString(),
            first_name: user.first_name,
            username: user.username,
            photo_url: user.photo_url,
            language_code: user.language_code,
            is_premium: user.is_premium || false
          };
          
          handleTelegramAuth(telegramUser);
        }
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –ø–æ–¥ Telegram
        setupTelegramTheme(tg);
      }
    }

    function setupTelegramTheme(tg) {
      tg.setHeaderColor('#0088cc');
      tg.setBackgroundColor('#f7f9fc');
      
      tg.onEvent('themeChanged', () => {
        const isDark = tg.colorScheme === 'dark';
        enableDarkMode(isDark);
      });
      
      const isDark = tg.colorScheme === 'dark';
      enableDarkMode(isDark);
    }

    // –§—É–Ω–∫—Ü–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    function handleTelegramAuth(user) {
      currentUser = user;
      localStorage.setItem('telegramUser', JSON.stringify(user));
      showUserMiniInfo(user);
      
      // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –¥–ª—è –≤—Ö–æ–¥–∞
      document.getElementById('telegramLoginPrompt').style.display = 'none';
      
      saveUserToServer(user);
      loadTradesFromServer();
    }

    function showUserMiniInfo(user) {
      const userMiniCard = document.getElementById('userMiniCard');
      userMiniCard.style.display = 'flex';
      
      document.getElementById('userMiniName').textContent = user.first_name;
      document.getElementById('userMiniId').textContent = `ID: ${user.id}`;
      
      if (user.photo_url) {
        document.getElementById('userMiniAvatar').src = user.photo_url;
      } else {
        document.getElementById('userMiniAvatar').src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzUiIGhlaWdodD0iMzUiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMjUiIGZpbGw9IiMzNDk4REIiLz4KPHN2ZyB4PSIxMi41IiB5PSIxMi41IiB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDMTMuMSAyIDE0IDIuOSAxNCA0QzE0IDUuMSAxMy4xIDYgMTIgNkMxMC45IDYgMTAgNS4xIDEwIDRDMTAgMi45IDEwLjkgMiAxMiAyWk0yMSAxNkMyMSAxNC43IDIwLjEgMTMuNiAxOC45IDEzLjNDMTguNSAxMi45IDE3LjggMTIuNyAxNy4yIDEyLjdDMTYuNiAxMi43IDE1LjkgMTIuOSAxNS41IDEzLjNDMTQuOSAxMy42IDE0IDE0LjcgMTQgMTZWMjFIMjFWMTZaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4KPC9zdmc+';
      }
    }

    function logout() {
      if (confirm("–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?")) {
        currentUser = null;
        localStorage.removeItem('telegramUser');
        
        document.getElementById('userMiniCard').style.display = 'none';
        document.getElementById('telegramLoginPrompt').style.display = 'flex';
        updateSyncStatusMini('', '');
        
        if (isTelegramWebApp) {
          // –í —Ä–µ–∂–∏–º–µ Telegram –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
          location.reload();
        }
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ç–µ–∫—É—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞
    function calculateCurrentBalance() {
      const depositAmount = parseFloat(document.getElementById("depositAmount").value) || 0;
      const depositCurrency = document.getElementById("depositCurrency").value;
      
      // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ —Ä—É–±–ª–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
      let initialDeposit = depositAmount;
      if (depositCurrency === 'USD') {
        initialDeposit = depositAmount * USD_RATE;
      }
      
      const totalProfit = trades.reduce((sum, trade) => sum + parseFloat(trade.profitMoney), 0);
      return initialDeposit + totalProfit;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞
    function updateCurrentBalance() {
      const currentBalance = calculateCurrentBalance();
      const currentBalanceUsd = (currentBalance / USD_RATE).toFixed(2);
      
      document.getElementById('currentBalanceRub').textContent = currentBalance.toFixed(2) + ' —Ä—É–±';
      document.getElementById('currentBalanceUsd').textContent = currentBalanceUsd + ' USD';
      
      return currentBalance;
    }

    // API —Ñ—É–Ω–∫—Ü–∏–∏
    async function saveUserToServer(user) {
      try {
        const response = await fetch(`${SERVER_URL}/users`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            telegramId: user.id,
            firstName: user.first_name,
            username: user.username,
            photoUrl: user.photo_url,
            languageCode: user.language_code,
            isPremium: user.is_premium
          })
        });
        
        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ');
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
      }
    }

    async function saveTradesToServer(action = 'replace') {
      if (!currentUser) return;
      
      try {
        updateSyncStatusMini('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...', 'loading');
        
        const url = action === 'add' ? `${SERVER_URL}/trades/add` : `${SERVER_URL}/trades`;
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            telegramId: currentUser.id,
            trades: trades,
            action: action
          })
        });
        
        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–¥–µ–ª–æ–∫');
        
        const result = await response.json();
        updateSyncStatusMini('–î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã', 'success');
        isOnline = true;
        return result;
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–¥–µ–ª–æ–∫:', error);
        updateSyncStatusMini('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', 'error');
        isOnline = false;
        saveTradesToLocalStorage();
      }
    }

    async function loadTradesFromServer() {
      if (!currentUser) return;
      
      try {
        updateSyncStatusMini('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...', 'loading');
        
        const response = await fetch(`${SERVER_URL}/trades/${currentUser.id}`);
        
        if (!response.ok) {
          loadTradesFromLocalStorage();
          updateSyncStatusMini('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞', 'warning');
          return;
        }
        
        const data = await response.json();
        trades = data.trades || [];
        updateSyncStatusMini('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
        isOnline = true;
        
        saveTradesToLocalStorage();
        updateCurrentBalance();
        updateHistory();
        updateAnalytics();
        renderChart();
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–¥–µ–ª–æ–∫:', error);
        loadTradesFromLocalStorage();
        updateSyncStatusMini('–û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º', 'error');
        isOnline = false;
      }
    }

    // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–¥–µ–ª–æ–∫
    function saveTradesToLocalStorage() {
      localStorage.setItem('trades', JSON.stringify(trades));
    }

    function loadTradesFromLocalStorage() {
      const savedTrades = localStorage.getItem('trades');
      if (savedTrades) {
        trades = JSON.parse(savedTrades);
      } else {
        trades = [];
      }
      updateCurrentBalance();
      updateHistory();
      updateAnalytics();
      renderChart();
    }

    function updateSyncStatusMini(message, type) {
      const statusElement = document.getElementById('syncStatusMini');
      statusElement.textContent = message;
      statusElement.className = 'sync-status-mini';
      
      if (type === 'success') statusElement.classList.add('sync-success');
      if (type === 'error') statusElement.classList.add('sync-error');
      if (type === 'warning') statusElement.classList.add('sync-warning');
      if (type === 'loading') statusElement.classList.add('loading');
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
      if (type === 'success') {
        setTimeout(() => {
          if (statusElement.textContent === message) {
            statusElement.textContent = '';
            statusElement.className = 'sync-status-mini';
          }
        }, 3000);
      }
    }

    // –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
    function calculate() {
      try {
        const currentBalance = updateCurrentBalance();
        const riskPercentOnTrade = parseFloat(document.getElementById("riskPercent").value);
        const entry = parseFloat(document.getElementById("entry").value);
        const sl = parseFloat(document.getElementById("sl").value);
        const leverage = parseInt(document.getElementById("leverage").value);
        const ticker = document.getElementById("ticker").value;

        // –°–±–æ—Ä TP –∏–∑ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π
        const tpElements = document.querySelectorAll('.tp-section');
        const tps = [];
        
        tpElements.forEach(section => {
          const priceInput = section.querySelector('.tp-price');
          const sizeInput = section.querySelector('.tp-size');
          const price = parseFloat(priceInput.value) || 0;
          const size = parseFloat(sizeInput.value) || 0;
          
          if (price > 0) {
            tps.push({ price, size });
          }
        });

        if (!entry || !sl) {
          alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ü–µ–Ω—É –≤—Ö–æ–¥–∞ –∏ —Å—Ç–æ–ø-–ª–æ—Å—Å.");
          return;
        }

        if (tps.length === 0) {
          alert("–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω TP!");
          return;
        }

        const totalTP = tps.reduce((sum, tp) => sum + tp.size, 0);
        if (totalTP !== 100) {
          alert("–°—É–º–º–∞ TP –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 100%!");
          return;
        }

        // –†–∞—Å—á–µ—Ç –¥–µ–Ω–µ–∂–Ω–æ–≥–æ —Ä–∏—Å–∫–∞ (–æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞!)
        const moneyRiskRub = (currentBalance * riskPercentOnTrade) / 100;
        const moneyRiskUsd = moneyRiskRub / USD_RATE;

        // –†–∞—Å—á–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–∞ —Ä–∏—Å–∫–∞ –æ—Ç —Ü–µ–Ω—ã
        let priceRiskPercent;
        if (entry > sl) {
          priceRiskPercent = ((entry - sl) / entry) * 100;
        } else {
          priceRiskPercent = ((sl - entry) / entry) * 100;
        }

        // –†–∞—Å—á–µ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –ø—Ä–∏–±—ã–ª–∏ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –æ—Ç —Ü–µ–Ω—ã
        let priceProfitPercent = 0;
        if (entry > sl) {
          tps.forEach(tp => {
            if (tp.price > entry) priceProfitPercent += ((tp.price - entry) / entry) * (tp.size / 100);
          });
        } else {
          tps.forEach(tp => {
            if (tp.price < entry) priceProfitPercent += ((entry - tp.price) / entry) * (tp.size / 100);
          });
        }
        priceProfitPercent *= 100;

        // –†–∞—Å—á–µ—Ç R:R
        const rr = priceProfitPercent / priceRiskPercent;

        // –†–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏
        const positionSizeUSDT = moneyRiskUsd / (priceRiskPercent / 100);
        
        // –†–∞—Å—á–µ—Ç –ø—Ä–∏–±—ã–ª–∏
        const profitUsd = positionSizeUSDT * (priceProfitPercent / 100) * leverage;
        const profitRub = profitUsd * USD_RATE;
        
        // –ü—Ä–∏–±—ã–ª—å –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –æ—Ç –±–∞–ª–∞–Ω—Å–∞
        const profitPercentBalance = (profitRub / currentBalance) * 100;

        // –†–ê–°–ß–ï–¢–´ –î–õ–Ø –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å!)
        // –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏ –≤ % –æ—Ç –±–∞–ª–∞–Ω—Å–∞
        const positionSizePercent = (positionSizeUSDT * USD_RATE / currentBalance) * 100;
        
        // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∞—Ä–∂–∏ (%)
        const marginUsage = (positionSizeUSDT * USD_RATE * leverage / currentBalance) * 100;
        
        // –°–≤–æ–±–æ–¥–Ω–∞—è –º–∞—Ä–∂–∞ –ø–æ—Å–ª–µ —Å–¥–µ–ª–∫–∏ (–æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞!)
        const freeMarginAfter = currentBalance - (positionSizeUSDT * USD_RATE * leverage / 100);
        
        // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–µ–ø–æ–∑–∏—Ç–∞
        const maxDepositUsage = Math.min(marginUsage, 100);
        
        // –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –æ–±—ä–µ–º –ø–æ–∑–∏—Ü–∏–∏ (–Ω–µ –±–æ–ª–µ–µ 30% –æ—Ç –±–∞–ª–∞–Ω—Å–∞ —Å —É—á–µ—Ç–æ–º –ø–ª–µ—á–∞)
        const recommendedPositionSize = (currentBalance * 0.3) / (USD_RATE * leverage);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞—Å—á–µ—Ç
        currentCalculation = {
          moneyRiskRub,
          moneyRiskUsd,
          priceRiskPercent,
          priceProfitPercent,
          rr: rr.toFixed(2),
          leverage,
          profitRub,
          profitUsd,
          profitPercentBalance,
          positionSizeUSDT,
          positionSizePercent,
          marginUsage,
          freeMarginAfter,
          maxDepositUsage,
          recommendedPositionSize,
          tps: tps
        };

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        document.getElementById("resultTicker").textContent = ticker;
        document.getElementById("moneyRisk").textContent = moneyRiskRub.toFixed(2);
        document.getElementById("moneyRiskUsd").textContent = moneyRiskUsd.toFixed(2);
        document.getElementById("riskPercentVal").textContent = priceRiskPercent.toFixed(2);
        document.getElementById("profitPercentVal").textContent = priceProfitPercent.toFixed(2);
        document.getElementById("rrValue").textContent = rr.toFixed(2);
        document.getElementById("leverageUsed").textContent = leverage;
        document.getElementById("profitMoney").textContent = profitRub.toFixed(2);
        document.getElementById("profitUsd").textContent = profitUsd.toFixed(2);
        document.getElementById("profitPercentDeposit").textContent = profitPercentBalance.toFixed(2);
        document.getElementById("positionSize").textContent = positionSizeUSDT.toFixed(2);

        // –ù–û–í–´–ï –ü–û–õ–Ø
        document.getElementById("positionSizePercent").textContent = positionSizePercent.toFixed(2);
        document.getElementById("marginUsage").textContent = marginUsage.toFixed(2);
        document.getElementById("freeMarginAfter").textContent = freeMarginAfter.toFixed(2);
        document.getElementById("maxDepositUsage").textContent = maxDepositUsage.toFixed(2);
        document.getElementById("recommendedPositionSize").textContent = recommendedPositionSize.toFixed(2);

        const rrEl = document.getElementById("rrValue");
        rrEl.className = rr >= 2 ? "rr-good" : rr >= 1 ? "rr-warn" : "";

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
        checkSafetyWarnings(positionSizePercent, marginUsage, riskPercentOnTrade, leverage);

        document.getElementById("result").style.display = "block";
      } catch (error) {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ: " + error.message);
        console.error(error);
      }
    }

    // –§—É–Ω–∫—Ü–∏—è: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å–¥–µ–ª–∫–∏
    function checkSafetyWarnings(positionSizePercent, marginUsage, riskPercent, leverage) {
      const warningsSection = document.getElementById("warningsSection");
      const warningsList = document.getElementById("warningsList");
      warningsList.innerHTML = '';
      
      let hasWarnings = false;
      let warnings = [];

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∏—Å–∫–∞ –Ω–∞ —Å–¥–µ–ª–∫—É
      if (riskPercent > 3) {
        warnings.push({
          level: 'high',
          message: '‚ùå –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –Ω–∞ —Å–¥–µ–ª–∫—É (>3%). –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 1-2%'
        });
      } else if (riskPercent > 2) {
        warnings.push({
          level: 'medium',
          message: '‚ö†Ô∏è –ü–æ–≤—ã—à–µ–Ω–Ω—ã–π —Ä–∏—Å–∫ –Ω–∞ —Å–¥–µ–ª–∫—É (>2%). –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã'
        });
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–∞—Ä–∂–∏
      if (marginUsage > 80) {
        warnings.push({
          level: 'high',
          message: '‚ùå –û—á–µ–Ω—å –≤—ã—Å–æ–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∞—Ä–∂–∏ (>80%). –†–∏—Å–∫ –º–∞—Ä–∂–∏–Ω-–∫–æ–ª–ª–∞'
        });
      } else if (marginUsage > 50) {
        warnings.push({
          level: 'medium',
          message: '‚ö†Ô∏è –í—ã—Å–æ–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∞—Ä–∂–∏ (>50%). –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –æ–±—ä–µ–º'
        });
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–∑–∏—Ü–∏–∏
      if (positionSizePercent > 50) {
        warnings.push({
          level: 'high',
          message: '‚ùå –°–ª–∏—à–∫–æ–º –∫—Ä—É–ø–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è (>50% –±–∞–ª–∞–Ω—Å–∞). –î–∏–≤–µ—Ä—Å–∏—Ñ–∏—Ü–∏—Ä—É–π—Ç–µ'
        });
      } else if (positionSizePercent > 30) {
        warnings.push({
          level: 'medium',
          message: '‚ö†Ô∏è –ö—Ä—É–ø–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è (>30% –±–∞–ª–∞–Ω—Å–∞). –£–≤–µ–ª–∏—á—å—Ç–µ –¥–µ–ø–æ–∑–∏—Ç'
        });
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–µ—á–∞
      if (leverage > 50) {
        warnings.push({
          level: 'high',
          message: '‚ùå –û—á–µ–Ω—å –≤—ã—Å–æ–∫–æ–µ –ø–ª–µ—á–æ (>50x). –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –ª–∏–∫–≤–∏–¥–∞—Ü–∏–∏'
        });
      } else if (leverage > 20) {
        warnings.push({
          level: 'medium',
          message: '‚ö†Ô∏è –í—ã—Å–æ–∫–æ–µ –ø–ª–µ—á–æ (>20x). –£–≤–µ–ª–∏—á—å—Ç–µ —Å—Ç–æ–ø-–ª–æ—Å—Å'
        });
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ R:R
      const rr = parseFloat(document.getElementById("rrValue").textContent);
      if (rr < 1) {
        warnings.push({
          level: 'high',
          message: '‚ùå –ù–∏–∑–∫–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ R:R (<1). –°–¥–µ–ª–∫–∞ –Ω–µ–≤—ã–≥–æ–¥–Ω–∞'
        });
      } else if (rr < 1.5) {
        warnings.push({
          level: 'medium',
          message: '‚ö†Ô∏è –ù–∏–∑–∫–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ R:R (<1.5). –£–ª—É—á—à–∏—Ç–µ —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç'
        });
      }

      // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
      if (warnings.length > 0) {
        hasWarnings = true;
        warnings.forEach(warning => {
          const warningElement = document.createElement('div');
          warningElement.className = `warning-item warning-${warning.level}`;
          warningElement.textContent = warning.message;
          warningsList.appendChild(warningElement);
        });
      }

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
      if (hasWarnings) {
        warningsSection.style.display = 'block';
        warningsSection.style.background = '#fff3cd';
        warningsSection.style.borderColor = '#ffeaa7';
      } else {
        warningsSection.style.display = 'none';
      }
    }

    // –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å–æ —Å–¥–µ–ª–∫–∞–º–∏
    async function saveTrade() {
      if (!currentCalculation) {
        alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ä–∞—Å—á—ë—Ç.");
        return;
      }

      try {
        // –°–æ–±–∏—Ä–∞–µ–º TP –∏–∑ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π
        const tpElements = document.querySelectorAll('.tp-section');
        const tps = [];
        
        tpElements.forEach(section => {
          const priceInput = section.querySelector('.tp-price');
          const sizeInput = section.querySelector('.tp-size');
          const price = parseFloat(priceInput.value) || 0;
          const size = parseFloat(sizeInput.value) || 0;
          
          if (price > 0) {
            tps.push({ price, size });
          }
        });

        const trade = {
          id: generateId(),
          date: new Date().toLocaleString('ru-RU'),
          timestamp: new Date().toISOString(),
          ticker: document.getElementById("resultTicker").textContent,
          entry: parseFloat(document.getElementById("entry").value),
          sl: parseFloat(document.getElementById("sl").value),
          tps: tps,
          leverage: parseInt(document.getElementById("leverage").value),
          rr: currentCalculation.rr,
          profitMoney: currentCalculation.profitRub.toFixed(2),
          profitUsd: currentCalculation.profitUsd.toFixed(2),
          moneyRiskRub: currentCalculation.moneyRiskRub,
          potentialProfitRub: currentCalculation.profitRub,
          closedBy: 'tp'
        };

        trades.push(trade);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä –µ—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –∏–Ω–∞—á–µ –ª–æ–∫–∞–ª—å–Ω–æ
        if (currentUser) {
          await saveTradesToServer();
        } else {
          saveTradesToLocalStorage();
        }
        
        updateCurrentBalance();
        updateHistory();
        updateAnalytics();
        renderChart();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        if (isTelegramWebApp && window.Telegram.WebApp.showPopup) {
          window.Telegram.WebApp.showPopup({
            title: '–°–¥–µ–ª–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!',
            message: `–¢–∏–∫–µ—Ä: ${trade.ticker}\n–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–∏–±—ã–ª—å: ${trade.profitMoney} —Ä—É–±`,
            buttons: [{ type: 'ok' }]
          });
        } else {
          showNotification('–°–¥–µ–ª–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
        }
      } catch (error) {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–¥–µ–ª–∫–∏: " + error.message);
        console.error(error);
      }
    }

    // –§—É–Ω–∫—Ü–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Å–¥–µ–ª–æ–∫
    function updateHistory() {
      const tbody = document.getElementById("historyBody");
      const mobileHistory = document.getElementById("mobileHistory");
      
      if (trades.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty">–ü–æ–∫–∞ –Ω–µ—Ç —Å–¥–µ–ª–æ–∫</td></tr>';
        mobileHistory.innerHTML = '<div class="empty">–ü–æ–∫–∞ –Ω–µ—Ç —Å–¥–µ–ª–æ–∫</div>';
        return;
      }

      // –î–µ—Å–∫—Ç–æ–ø –≤–µ—Ä—Å–∏—è
      tbody.innerHTML = '';
      trades.forEach((t, index) => {
        const row = document.createElement("tr");
        const isProfit = parseFloat(t.profitMoney) >= 0;
        const profitClass = isProfit ? 'profit-positive' : 'profit-negative';
        
        let entryExitText = `${t.entry} ‚Üí `;
        if (t.closedBy === 'tp') {
          entryExitText += `TP: ${t.tps.map(tp => tp.price).join(', ')}`;
        } else {
          entryExitText += `SL: ${t.sl}`;
        }

        row.innerHTML = `
          <td>${t.date}</td>
          <td>${t.ticker}</td>
          <td>${entryExitText}</td>
          <td class="${t.rr >= 2 ? 'rr-good' : t.rr >= 1 ? 'rr-warn' : ''}">${t.rr}</td>
          <td class="${profitClass}">${t.profitMoney} —Ä—É–±</td>
          <td>
            <select class="close-type-select" onchange="updateTradeCloseType(${index}, this.value)">
              <option value="tp" ${t.closedBy === 'tp' ? 'selected' : ''}>–ø–æ TP</option>
              <option value="sl" ${t.closedBy === 'sl' ? 'selected' : ''}>–ø–æ —Å—Ç–æ–ø—É</option>
            </select>
          </td>
          <td>x${t.leverage}</td>
          <td>
            <button class="edit-trade" onclick="editTrade(${index})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úé</button>
            <button class="delete-trade" onclick="deleteTrade(${index})" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
          </td>
        `;
        tbody.appendChild(row);
      });

      // –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è
      mobileHistory.innerHTML = '';
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ mobileVisibleCount —Å–¥–µ–ª–æ–∫
      const visibleTrades = trades.slice(0, mobileVisibleCount);
      
      visibleTrades.forEach((t, index) => {
        const isProfit = parseFloat(t.profitMoney) >= 0;
        const profitClass = isProfit ? 'profit-positive' : 'profit-negative';
        const profitSign = isProfit ? '+' : '';
        
        let entryExitText = `${t.entry} ‚Üí `;
        if (t.closedBy === 'tp') {
          entryExitText += `TP: ${t.tps.map(tp => tp.price).join(', ')}`;
        } else {
          entryExitText += `SL: ${t.sl}`;
        }

        const card = document.createElement("div");
        card.className = "mobile-trade-card";
        card.innerHTML = `
          <div class="mobile-trade-header">
            <div class="mobile-trade-ticker">${t.ticker}</div>
            <div class="mobile-trade-date">${t.date}</div>
          </div>
          
          <div class="mobile-trade-main-info">
            <div class="mobile-trade-entry-exit">${entryExitText}</div>
            
            <div class="mobile-trade-stats">
              <div class="mobile-trade-rr">
                <span>R:R</span>
                <span class="${t.rr >= 2 ? 'rr-good' : t.rr >= 1 ? 'rr-warn' : ''}">${t.rr}</span>
              </div>
              <div class="mobile-trade-leverage">
                <span>–ü–ª–µ—á–æ</span>
                <span>x${t.leverage}</span>
              </div>
            </div>
            
            <div class="mobile-trade-close-type">
              <select class="close-type-select" onchange="updateTradeCloseType(${index}, this.value)">
                <option value="tp" ${t.closedBy === 'tp' ? 'selected' : ''}>–ø–æ TP</option>
                <option value="sl" ${t.closedBy === 'sl' ? 'selected' : ''}>–ø–æ —Å—Ç–æ–ø—É</option>
              </select>
            </div>
          </div>
          
          <div class="mobile-trade-actions">
            <div class="mobile-trade-result ${profitClass}">${profitSign}${t.profitMoney} —Ä—É–±</div>
            <div class="mobile-trade-buttons">
              <button class="edit-trade" onclick="editTrade(${index})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úé</button>
              <button class="delete-trade" onclick="deleteTrade(${index})" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
            </div>
          </div>
        `;
        mobileHistory.appendChild(card);
      });

      // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–∫–∞–∑–∞—Ç—å –µ—â–µ" –µ—Å–ª–∏ –µ—Å—Ç—å –µ—â–µ —Å–¥–µ–ª–∫–∏
      if (trades.length > mobileVisibleCount) {
        const loadMoreContainer = document.createElement("div");
        loadMoreContainer.className = "load-more-container";
        loadMoreContainer.innerHTML = `
          <button class="load-more-btn" onclick="loadMoreTrades()">
            üìÉ –ü–æ–∫–∞–∑–∞—Ç—å –µ—â–µ (${trades.length - mobileVisibleCount})
          </button>
        `;
        mobileHistory.appendChild(loadMoreContainer);
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–¥–µ–ª–æ–∫
    function loadMoreTrades() {
      mobileVisibleCount += MOBILE_LOAD_MORE_COUNT;
      updateHistory();
    }

    async function deleteTrade(index) {
      if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å–¥–µ–ª–∫—É?")) {
        trades.splice(index, 1);
        if (currentUser) {
          await saveTradesToServer();
        } else {
          saveTradesToLocalStorage();
        }
        updateCurrentBalance();
        updateHistory();
        updateAnalytics();
        renderChart();
      }
    }

    async function updateTradeCloseType(index, closeType) {
      const trade = trades[index];
      trade.closedBy = closeType;
      
      if (closeType === 'tp') {
        trade.profitMoney = trade.potentialProfitRub.toFixed(2);
      } else {
        trade.profitMoney = (-trade.moneyRiskRub).toFixed(2);
      }
      
      trade.profitUsd = (parseFloat(trade.profitMoney) / USD_RATE).toFixed(2);
      if (currentUser) {
        await saveTradesToServer();
      } else {
        saveTradesToLocalStorage();
      }
      updateCurrentBalance();
      updateHistory();
      updateAnalytics();
      renderChart();
    }

    function editTrade(index) {
      const trade = trades[index];
      
      document.getElementById("ticker").value = trade.ticker;
      document.getElementById("entry").value = trade.entry;
      document.getElementById("sl").value = trade.sl;
      document.getElementById("leverage").value = trade.leverage;
      
      // –û—á–∏—â–∞–µ–º –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º TP –ø–æ–ª—è
      const tpContainer = document.getElementById('tp-container');
      tpContainer.innerHTML = '';
      
      trade.tps.forEach((tp, i) => {
        addTpField();
        const lastTpSection = tpContainer.lastElementChild;
        const priceInput = lastTpSection.querySelector('.tp-price');
        const sizeInput = lastTpSection.querySelector('.tp-size');
        
        priceInput.value = tp.price;
        sizeInput.value = tp.size;
      });
      
      calculate();
      showNotification("–°–¥–µ–ª–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –≤ —Ñ–æ—Ä–º—É. –í—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å.", "success");
    }

    function updateAnalytics() {
      if (trades.length === 0) {
        document.getElementById("totalTrades").textContent = "0";
        document.getElementById("avgRR").textContent = "‚Äî";
        document.getElementById("winningTrades").textContent = "0";
        document.getElementById("losingTrades").textContent = "0";
        document.getElementById("totalProfit").textContent = "0 —Ä—É–±";
        return;
      }

      const total = trades.length;
      const winning = trades.filter(t => parseFloat(t.profitMoney) > 0).length;
      const losing = trades.filter(t => parseFloat(t.profitMoney) < 0).length;
      const avgRR = trades.reduce((sum, t) => sum + parseFloat(t.rr), 0) / total;
      const totalProfitRub = trades.reduce((sum, t) => sum + parseFloat(t.profitMoney), 0);

      document.getElementById("totalTrades").textContent = total;
      document.getElementById("avgRR").textContent = avgRR.toFixed(2);
      document.getElementById("winningTrades").textContent = winning;
      document.getElementById("losingTrades").textContent = losing;
      document.getElementById("totalProfit").textContent = totalProfitRub.toFixed(2) + " —Ä—É–±";
    }

    function renderChart() {
      const ctx = document.getElementById('profitChart').getContext('2d');
      if (profitChart) profitChart.destroy();

      const labels = trades.map((_, i) => `–°–¥–µ–ª–∫–∞ ${i+1}`);
      let balance = calculateCurrentBalance() - trades.reduce((sum, t) => sum + parseFloat(t.profitMoney), 0);
      const data = [balance];

      trades.forEach(t => {
        balance += parseFloat(t.profitMoney);
        data.push(balance);
      });

      profitChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['–ù–∞—á–∞–ª–æ', ...labels],
          datasets: [{
            label: '–ë–∞–ª–∞–Ω—Å (—Ä—É–±)',
            data,
            borderColor: '#3498db',
            backgroundColor: 'rgba(52, 152, 219, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            tooltip: { mode: 'index', intersect: false }
          },
          scales: {
            y: { 
              beginAtZero: false,
              grid: { color: 'rgba(0,0,0,0.1)' }
            },
            x: {
              grid: { color: 'rgba(0,0,0,0.1)' }
            }
          }
        }
      });
    }

    // –≠–∫—Å–ø–æ—Ä—Ç –∏ –∏–º–ø–æ—Ä—Ç
    function exportToCSV() {
      if (trades.length === 0) {
        alert("–ù–µ—á–µ–≥–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å.");
        return;
      }

      const headers = ["–î–∞—Ç–∞", "–¢–∏–∫–µ—Ä", "–í—Ö–æ–¥", "SL", "TPs", "–ü–ª–µ—á–æ", "R:R", "–†–µ–∑—É–ª—å—Ç–∞—Ç (—Ä—É–±)", "–¢–∏–ø –∑–∞–∫—Ä—ã—Ç–∏—è", "ID"];
      const rows = trades.map(t => [
        t.date, 
        t.ticker, 
        t.entry, 
        t.sl, 
        t.tps.map(tp => `${tp.price}:${tp.size}`).join(';'), 
        `x${t.leverage}`, 
        t.rr, 
        t.profitMoney,
        t.closedBy === 'sl' ? '–ø–æ —Å—Ç–æ–ø-–ª–æ—Å—Å—É' : '–ø–æ —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç—É',
        t.id
      ]);

      const csvContent = [headers.join(";"), ...rows.map(row => row.join(";"))].join("\n");
      const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", `trading_history_${new Date().toISOString().slice(0,10)}.csv`);
      link.click();
    }

    function importFromCSV() {
      document.getElementById('importFile').click();
    }

    function handleImport(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          let content = e.target.result;
          if (content.charCodeAt(0) === 0xFEFF) content = content.slice(1);
          
          const lines = content.split('\n');
          const importedTrades = [];
          
          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            const fields = line.split(';');
            if (fields.length >= 6) {
              // –ü–∞—Ä—Å–∏–º TPs
              const tps = [];
              const tpFields = fields[4].split(';');
              tpFields.forEach(tpField => {
                const [price, size] = tpField.split(':');
                if (price && size) {
                  tps.push({
                    price: parseFloat(price) || 0,
                    size: parseFloat(size) || 0
                  });
                }
              });

              const trade = {
                id: fields[9] || generateId(),
                date: fields[0],
                ticker: fields[1],
                entry: parseFloat(fields[2]) || 0,
                sl: parseFloat(fields[3]) || 0,
                tps: tps,
                leverage: parseInt(fields[5].replace('x', '')) || 1,
                rr: fields[6] || '0',
                profitMoney: fields[7] || '0',
                closedBy: fields[8] && fields[8].includes('—Å—Ç–æ–ø') ? 'sl' : 'tp',
                profitUsd: (parseFloat(fields[7]) / USD_RATE).toFixed(2),
                moneyRiskRub: Math.abs(parseFloat(fields[7])) * 0.1,
                potentialProfitRub: parseFloat(fields[7]),
                timestamp: new Date().toISOString()
              };
              
              importedTrades.push(trade);
            }
          }
          
          if (importedTrades.length > 0) {
            const userChoice = confirm(`–ù–∞–π–¥–µ–Ω–æ ${importedTrades.length} —Å–¥–µ–ª–æ–∫. –î–æ–±–∞–≤–∏—Ç—å –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º? (OK - –¥–æ–±–∞–≤–∏—Ç—å, –û—Ç–º–µ–Ω–∞ - –∑–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ)`);
            
            if (userChoice) {
              // –î–æ–±–∞–≤–ª—è–µ–º –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º
              trades = [...trades, ...importedTrades];
              if (currentUser) {
                await saveTradesToServer('add');
              } else {
                saveTradesToLocalStorage();
              }
              showNotification(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${importedTrades.length} —Å–¥–µ–ª–æ–∫ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º!`, 'success');
            } else {
              // –ó–∞–º–µ–Ω—è–µ–º –≤—Å–µ
              trades = importedTrades;
              if (currentUser) {
                await saveTradesToServer('replace');
              } else {
                saveTradesToLocalStorage();
              }
              showNotification(`–í—Å–µ —Å–¥–µ–ª–∫–∏ –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ ${importedTrades.length} –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö!`, 'success');
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ
            mobileVisibleCount = 5;
            
            updateCurrentBalance();
            updateHistory();
            updateAnalytics();
            renderChart();
          } else {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Å–¥–µ–ª–∫–∏ –≤ —Ñ–∞–π–ª–µ.");
          }
        } catch (error) {
          alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ —Ñ–∞–π–ª–∞: " + error.message);
          console.error(error);
        }
        
        event.target.value = '';
      };
      
      reader.readAsText(file, 'utf-8');
    }

    function clearHistory() {
      if (confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –∏ –≥—Ä–∞—Ñ–∏–∫?")) {
        trades = [];
        mobileVisibleCount = 5; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
        if (currentUser) {
          saveTradesToServer('replace');
        } else {
          saveTradesToLocalStorage();
        }
        updateCurrentBalance();
        updateHistory();
        updateAnalytics();
        renderChart();
      }
    }

    // –¢–µ–º–∞
    function enableDarkMode(dark) {
      const body = document.body;
      const icon = document.getElementById('themeIcon');

      if (dark) {
        body.classList.add('dark-mode');
        icon.innerHTML = `<path d="M12 17a5 5 0 1 0 0-10 5 5 0 0 0 0 10zm0-12a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0V6a1 1 0 0 1 1-1zm0 13a1 1 0 0 1-1 1v1a1 1 0 1 1 2 0v-1a1 1 0 0 1-1-1zm7.07-7.07a1 1 0 0 1 0 1.414l-.707.707a1 1 0 1 1-1.414-1.414l.707-.707a1 1 0 0 1 1.414 0zm-14.14 0a1 1 0 0 1 1.414 0l.707.707A1 1 0 1 1 5.64 12.22l-.707-.707a1 1 0 0 1 0-1.414zm7.07 7.07a1 1 0 0 1-1.414 0l-.707-.707a1 1 0 1 1 1.414-1.414l.707.707a1 1 0 0 1 0 1.414zm0-14.14a1 1 0 0 1 1.414 0l.707.707A1 1 0 1 1 18.36 5.78l-.707-.707a1 1 0 0 1-1.414 0z"/>`;
      } else {
        body.classList.remove('dark-mode');
        icon.innerHTML = `<path d="M12 3a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0V4a1 1 0 0 1 1-1zm7.07 3.07a1 1 0 0 1 0 1.414l-.707.707a1 1 0 1 1-1.414-1.414l.707-.707a1 1 0 0 1 1.414 0zm-14.14 0a1 1 0 0 1 1.414 0l.707.707A1 1 0 1 1 5.64 5.78l-.707-.707a1 1 0 0 1 0-1.414zM12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8zm-7 4a7 7 0 0 1 14 0 7 7 0 1 1-14 0z" />`;
      }
      localStorage.setItem('darkMode', dark);
    }

    document.getElementById('themeToggle').addEventListener('click', function() {
      const isCurrentlyDark = document.body.classList.contains('dark-mode');
      enableDarkMode(!isCurrentlyDark);
    });
  </script>

@archlsv
</body>
</html>
